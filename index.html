<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EPIXGAMES Home 🎮</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Three.js library for 3D animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    :root {
      /* Default values - these will be overridden by JavaScript */
      --bg-color: #282c34; /* Will be a darker accent */
      --primary-color: #4287f5; /* Will be the accent color */
      --secondary-color: #61dafb; /* Will be the accent color */
      --text-color: #ffffff;
      --card-bg: #3c4048;
      --button-bg: var(--accent-color, #61dafb); /* Button background uses accent */
      --button-hover-bg: var(--accent-hover-color, #21a1f1); /* Button hover uses darker accent */
      --accent-color: #61dafb; /* Default accent color */
      --accent-hover-color: #21a1f1; /* Default accent hover color */

      /* Default accessory styles */
      --home-background: var(--bg-color);
      --home-text-color: var(--text-color);
    }

    body {
      background: var(--home-background); /* Changed from background-color to background */
      background-attachment: fixed; /* Added for parallax scrolling effect */
      color: var(--home-text-color); /* Now uses dynamic text color */
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      transition: background-color 0.5s ease; /* Smooth transition for background changes */
    }

    /* Removed body.animation-active background: transparent !important;
       The 3D canvas is z-index: -1, so it will appear behind the body's background.
       This allows the custom background to show through while cubes animate on top.
    */

    header {
      margin-bottom: 40px;
      width: 100%;
      max-width: 900px;
      position: relative; /* Make header a positioning context for absolute children */
      /* padding-right removed from header as search is now inside tab content */
      box-sizing: border-box; /* Include padding in width */
      text-align: center; /* Center header content */
    }

    .header-content {
      text-align: center; /* Center text within its container */
      margin: 0; /* Ensure no default margins push it down */
    }

    h1 {
      font-family: 'Press Start 2P', cursive;
      color: var(--primary-color); /* Now uses the accent color */
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 3px 3px #000;
      margin-top: 0; /* Reset default margin */
    }

    p {
      font-size: 1.1em;
      color: var(--text-color); /* Changed to use --text-color */
      margin-top: 0;
      transition: opacity 0.5s ease-in-out; /* Smooth text fade for dynamic subtitle */
    }

    h2 {
      font-family: 'Press Start 2P', cursive;
      color: var(--secondary-color); /* Now uses the accent color */
      font-size: 1.8em;
      margin-top: 40px;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 2px 2px #000;
    }

    /* Tabs Navigation */
    #tabs-container {
      display: flex;
      justify-content: center;
      width: 100%;
      max-width: 900px;
      margin-bottom: 30px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      overflow: hidden; /* Ensures rounded corners apply */
    }

    .tab-button {
      flex: 1;
      padding: 15px 20px;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: none;
      border-right: 1px solid rgba(255, 255, 255, 0.1); /* Separator */
      font-family: 'Press Start 2P', cursive;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      text-align: center;
    }

    .tab-button:last-child {
      border-right: none; /* No separator on the last button */
    }

    .tab-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .tab-button.active {
      background-color: var(--button-bg);
      color: var(--bg-color); /* Active button text contrasts with accent */
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); /* Inner shadow for active state */
    }

    /* Tab Content */
    .tab-content {
      display: none; /* Hidden by default */
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      box-sizing: border-box;
      position: relative; /* For search bar positioning within Games tab */
    }

    .tab-content.active {
      display: block; /* Show active tab content */
    }

    /* Games Tab Specific Styles */
    #games-tab {
      padding-top: 20px; /* Adjust padding as banner is moved */
      background-color: transparent; /* Make background transparent */
      box-shadow: none; /* Remove box shadow for transparent effect */
    }

    .games-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      width: 100%;
    }

    .game {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      padding: 15px;
      text-align: center;
      width: 200px;
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, border 0.3s ease; /* Added border transition */
      overflow: hidden; /* Ensures border-radius applies to content */
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* Pushes button to bottom */
      border: 2px solid transparent; /* Default transparent border */
    }

    .game:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
    }

    .game.highlighted-game { /* Highlighted style */
      border: 4px solid var(--accent-color); /* Stronger accent border */
      box-shadow: 0 0 25px var(--accent-color); /* Glowing effect */
      transform: scale(1.05); /* Slightly larger when highlighted */
    }

    /* Hidden Game Style */
    .game.hidden {
      display: none !important; /* Force hide */
    }

    /* Favorited Game Style */
    .game.favorited {
      border: 4px solid gold; /* Gold border for favorites */
      box-shadow: 0 0 20px gold; /* Gold glow */
      position: relative; /* For star icon positioning */
    }

    .favorite-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      color: gold;
      font-size: 1.5em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      z-index: 1; /* Ensure it's above image */
    }


    .game img {
      width: 100%;
      height: 150px; /* Fixed height for consistent look */
      object-fit: cover; /* Ensures images cover the area without distortion */
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid var(--primary-color); /* Border uses accent color */
    }

    .game dt {
      font-family: 'Roboto', sans-serif;
      font-size: 1.1em;
      font-weight: 700;
      color: var(--secondary-color); /* Game titles use accent color */
      margin-bottom: 10px;
    }

    .game h2 { /* For "SCRATCH version" */
      font-family: 'Roboto', sans-serif;
      font-size: 0.9em;
      color: #ccc; /* This specific h2 remains light grey */
      margin-top: 5px;
      margin-bottom: 15px;
      text-shadow: none; /* Override general h2 shadow */
    }

    .game form {
      margin-top: auto; /* Pushes form to the bottom */
    }

    .play-now-button {
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100%;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      display: block;
      text-align: center;
      text-decoration: none;
    }

    .play-now-button:hover {
      background-color: var(--button-hover-bg);
      transform: translateY(-2px);
    }

    /* Search Widget Container (now inside #games-tab) */
    .search-widget-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column; /* Always column to stack elements */
      align-items: flex-end; /* Align items to the right within the column */
      padding: 5px;
      width: 250px; /* Adjusted fixed width for the widget */
      box-sizing: border-box;
      z-index: 10;
      gap: 10px; /* Spacing between search bar and results */
    }

    /* Header Search Group (just the input and button) */
    .header-search-group {
      display: flex; /* Keep flex for input and button side-by-side */
      gap: 10px;
      align-items: center;
      width: 100%; /* Take full width of its parent (.search-widget-container) */
    }

    .header-search-group input[type="text"] {
      flex-grow: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: 2px solid var(--primary-color);
      background-color: #282c34;
      color: var(--text-color);
      font-family: 'Roboto', sans-serif;
      font-size: 0.9em;
    }

    .header-search-group button {
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 0.9em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .header-search-group button:hover {
      background-color: var(--button-hover-bg);
      transform: translateY(-2px);
    }

    /* Search Results now inside the widget container */
    #searchResults {
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px dashed var(--secondary-color);
      padding: 10px;
      margin-top: 10px; /* Add margin to separate from search bar */
      color: var(--text-color);
      text-align: left;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #searchResults p {
      margin: 5px 0;
      padding: 5px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }

    #searchResults p:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Iframe Game Player Styles */
    .game-player-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 10px;
      box-sizing: border-box;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .game-player-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .game-iframe-container {
      width: 95%;
      height: calc(100% - 100px);
      background-color: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
    }

    .game-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .game-controls-bar {
      width: 95%;
      height: 60px;
      background-color: var(--card-bg);
      border-radius: 12px;
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 0 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    }

    .game-controls-bar button {
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 0.9em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .game-controls-bar button:hover {
      background-color: var(--button-hover-bg);
      transform: translateY(-2px);
    }

    /* Store Tab Styles */
    .store-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      padding: 20px;
      justify-content: center;
      width: 100%;
    }

    .store-item {
      background-color: #282c34;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      padding: 15px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .store-item img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      border-radius: 8px;
      border: 2px solid var(--primary-color);
    }

    .store-item h4 {
      margin: 0;
      color: var(--secondary-color);
      font-size: 1.1em;
    }

    .store-item p {
      margin: 5px 0;
      font-size: 0.9em;
      color: var(--text-color); /* Changed to use --text-color */
    }

    .store-item button {
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 0.9em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .store-item button:hover:not(:disabled) {
      background-color: var(--button-hover-bg);
      transform: translateY(-2px);
    }

    .store-item button:disabled {
      background-color: #555;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .money-display {
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      font-size: 1.5em;
      color: gold;
      margin-bottom: 20px;
      text-shadow: 2px 2px #000;
    }

    /* Settings Tab Styles */
    .settings-section {
      background-color: #282c34;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .settings-section label {
      font-size: 1.1em;
      color: var(--secondary-color);
      margin-bottom: 5px;
      display: block;
    }

    .settings-section select, .settings-section input[type="color"] {
      padding: 8px;
      border-radius: 8px;
      border: 2px solid var(--primary-color);
      background-color: #3c4048;
      color: var(--text-color);
      font-family: 'Roboto', sans-serif;
      font-size: 1em;
      width: 100%;
      max-width: 250px;
      box-sizing: border-box;
    }

    .settings-section input[type="color"] {
      height: 40px;
      width: 80px;
    }

    .settings-section button {
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .settings-section button:hover {
      background-color: var(--button-hover-bg);
      transform: translateY(-2px);
    }

    .reset-button {
      background-color: #f44336 !important;
    }

    .reset-button:hover {
      background-color: #d32f2f !important;
    }

    .confirmation-message {
      color: #f44336;
      font-weight: bold;
      margin-top: 10px;
    }

    /* Settings Management List */
    .management-list {
      background-color: #3c4048;
      border-radius: 8px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--secondary-color);
    }

    .management-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
      color: var(--text-color);
    }

    .management-item:last-child {
      border-bottom: none;
    }

    .management-item button {
      padding: 5px 10px;
      font-size: 0.8em;
      border-radius: 5px;
      margin-left: 10px;
    }

    .management-item .unhide-button {
        background-color: #4CAF50; /* Green */
        color: white;
    }
    .management-item .unhide-button:hover {
        background-color: #45a049;
    }

    .management-item .unfavorite-button {
        background-color: #f44336; /* Red */
        color: white;
    }
    .management-item .unfavorite-button:hover {
        background-color: #d32f2f;
    }


    /* Custom Message Box Styles */
    #messageBox {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--card-bg);
      color: var(--text-color);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
      z-index: 1001;
      display: none;
      text-align: center;
      font-family: 'Roboto', sans-serif;
      font-size: 1.1em;
      max-width: 300px;
      box-sizing: border-box;
    }

    #messageBox button {
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      margin-top: 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #messageBox button:hover {
      background-color: var(--button-hover-bg);
    }

    /* Classic Theme Specific Styles */
    body.classic-theme {
      /* Base background and text color are set via JS variables */
    }

    body.classic-theme h1,
    body.classic-theme p,
    body.classic-theme h2,
    body.classic-theme .game dt,
    body.classic-theme .store-item h4, /* Added for white text */
    body.classic-theme .store-item p,  /* Added for white text */
    body.classic-theme .settings-section label, /* Added for white text */
    body.classic-theme #searchResults p /* Added for white text */
    {
      color: #ffffff !important; /* Force white text for all these elements */
      font-family: 'Verdana', sans-serif !important; /* Override Press Start 2P */
      text-shadow: none !important; /* Remove text shadow */
    }

    body.classic-theme .game dt {
      font-size: 14px !important;
      margin-top: 10px !important;
    }

    body.classic-theme #tabs-container,
    body.classic-theme .tab-content,
    body.classic-theme .game,
    body.classic-theme .store-item,
    body.classic-theme .settings-section,
    body.classic-theme #messageBox,
    body.classic-theme .context-menu, /* Classic theme for context menu */
    body.classic-theme .management-list /* Classic theme for management lists */
    {
      background-color: transparent !important; /* Make card backgrounds transparent */
      box-shadow: none !important; /* Remove shadows */
      border: none !important; /* Remove borders */
    }

    body.classic-theme .tab-button {
      background-color: transparent !important;
      border-right: none !important;
    }

    body.classic-theme .tab-button.active {
      /* This will now also look generic, but will still be 'active' due to its class */
      background-color: #e0e0e0 !important; /* Generic light grey */
      color: #333 !important; /* Dark text for contrast */
      border: 1px solid #a0a0a0 !important; /* Generic border */
      border-radius: 4px !important; /* Slight rounded corners */
      box-shadow: none !important;
    }
    body.classic-theme .tab-button.active:hover {
      background-color: #d0d0d0 !important; /* Darker grey on hover */
      transform: none !important;
    }


    body.classic-theme .play-now-button,
    body.classic-theme .header-search-group button,
    body.classic-theme .store-item button,
    body.classic-theme .settings-section button,
    body.classic-theme #messageBox button,
    body.classic-theme .management-item button /* Classic theme for management buttons */
    {
      background-color: #e0e0e0 !important; /* Generic light grey */
      color: #333 !important; /* Dark text for contrast */
      border: 1px solid #a0a0a0 !important; /* Generic border */
      border-radius: 4px !important; /* Slight rounded corners */
      padding: 8px 15px !important; /* Adjusted padding for generic look */
      font-size: 0.9em !important; /* Adjusted font size */
      font-weight: normal !important; /* Normal font weight */
      font-family: 'Roboto', sans-serif !important; /* Use Roboto for generic buttons */
      box-shadow: none !important; /* Remove shadows */
      transition: background-color 0.1s ease, transform 0.1s ease; /* Faster transition for generic feel */
    }

    body.classic-theme .play-now-button:hover,
    body.classic-theme .header-search-group button:hover,
    body.classic-theme .store-item button:hover,
    body.classic-theme .settings-section button:hover,
    body.classic-theme #messageBox button:hover,
    body.classic-theme .management-item button:hover /* Classic theme for management buttons */
    {
      background-color: #d0d0d0 !important; /* Darker grey on hover */
      transform: none !important; /* Remove translateY on hover */
    }

    body.classic-theme .game img {
      border: none !important; /* Remove image border */
    }

    body.classic-theme .header-search-group input[type="text"] {
      background-color: #ffffff !important; /* White background for input */
      color: #000000 !important; /* Black text for input */
      border: 1px solid #ccc !important; /* Light border */
      border-radius: 5px !important;
    }

    body.classic-theme #searchResults {
      background-color: #ffffff !important;
      color: #000000 !important;
      border: 1px solid #ccc !important;
    }

    body.classic-theme #searchResults p:hover {
      background-color: #eee !important;
    }

    /* New styles for iframe and its container in classic theme */
    body.classic-theme .game-player-overlay {
        background-color: rgba(0, 0, 0, 0.8) !important; /* Slightly darker overlay */
    }

    body.classic-theme .game-iframe-container {
        background-color: #ffffff !important; /* White background for the container */
        border-radius: 0 !important; /* Remove border-radius */
        box-shadow: none !important; /* Remove box-shadow */
        border: 1px solid #a0a0a0 !important; /* Add a generic border */
    }

    body.classic-theme .game-iframe {
        border: none !important; /* Ensure no internal border on the iframe itself */
    }

    body.classic-theme .game-controls-bar {
        background-color: #f0f0f0 !important; /* Light grey background for controls bar */
        border-radius: 0 !important; /* Remove border-radius */
        box-shadow: none !important; /* Remove box-shadow */
        border: 1px solid #a0a0a0 !important; /* Add a generic border */
        border-top: none !important; /* No top border to blend with iframe container */
    }

    /* RGB Theme Specific Styles for text */
    body.rgb-theme h1,
    body.rgb-theme p,
    body.rgb-theme h2,
    body.rgb-theme .game dt,
    body.rgb-theme .store-item h4, /* Added for white text */
    body.rgb-theme .store-item p,  /* Added for white text */
    body.rgb-theme .settings-section label, /* Added for white text */
    body.rgb-theme #searchResults p /* Added for white text */
    {
      color: #ffffff !important; /* Force white text for main content elements */
    }

    /* 3D Background Canvas */
    #background3DCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1; /* Send it to the background */
      display: none; /* Hidden by default, enabled by JS */
      background-color: transparent; /* Ensure canvas background is transparent */
    }

    /* More Tab Specific Styles */
    .more-links-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 20px;
      align-items: center;
      width: 100%;
    }

    .more-link-item {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      padding: 20px;
      width: 80%; /* Adjust width as needed */
      max-width: 600px;
      text-align: center;
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }

    .more-link-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
    }

    .more-link-item h3 {
      font-family: 'Press Start 2P', cursive;
      color: var(--primary-color);
      font-size: 1.2em;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .more-link-item p {
      font-size: 0.95em;
      color: #ccc;
      margin-bottom: 15px;
    }

    .more-link-item a {
      display: inline-block;
      background-color: var(--button-bg);
      color: var(--bg-color);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 0.9em;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .more-link-item a:hover {
      background-color: var(--button-hover-bg);
      transform: translateY(-2px);
    }

    /* New styles for the Suggest tab iframe */
    #suggest-tab iframe {
      width: 100%;
      height: 600px; /* Adjust height as needed for the form */
      border: 2px solid var(--primary-color); /* Matches other elements */
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      background-color: #fff; /* White background for the form content */
    }

    /* Command Prompt Styles */
    #commandPromptOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000; /* Above everything else */
      display: none; /* Hidden by default */
    }

    #console {
      background-color: #1a1a1a;
      border: 2px solid var(--primary-color);
      border-radius: 10px;
      width: 90%;
      max-width: 700px;
      height: 70%;
      max-height: 500px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); /* Glowing effect */
    }

    #consoleOutput {
      flex-grow: 1;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
      color: #00ff00; /* Green text for console */
      overflow-y: auto;
      white-space: pre-wrap; /* Preserve whitespace and wrap text */
      word-wrap: break-word; /* Break long words */
      border-bottom: 1px solid var(--secondary-color);
    }

    #commandInput {
      background-color: #000000;
      color: #00ff00;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 1em;
      border: none;
      padding: 10px 15px;
      width: 100%;
      box-sizing: border-box;
      outline: none;
    }

    /* Context Menu Styles */
    .context-menu {
      position: fixed; /* Crucial for overlay behavior */
      background-color: var(--card-bg);
      border: 1px solid var(--primary-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      padding: 8px 0;
      z-index: 1000; /* Ensure it's above other content but below message box/command prompt */
      display: none; /* Hidden by default */
      min-width: 150px;
    }

    .context-menu-item {
      padding: 10px 15px;
      color: var(--text-color);
      font-size: 0.95em;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .context-menu-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }


    /* Responsive adjustments */
    @media (min-width: 769px) {
      .search-widget-container {
        flex-direction: column; /* Always column on larger screens too */
        align-items: flex-end; /* Align items to the right within the column */
        width: 300px; /* Wider for desktop */
        left: auto; /* Reset left positioning */
        transform: none; /* Remove transform */
        right: 10px; /* Keep it on the right */
        top: 10px; /* Keep it at the top */
      }

      .header-search-group {
        width: 100%; /* Ensure search group takes full width of its parent */
      }

      #searchResults {
        margin-top: 10px; /* Ensure spacing below the search bar */
      }
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: center;
        gap: 15px;
        padding-right: 20px;
      }
      .header-content {
        text-align: center;
      }
      .search-widget-container {
        position: static;
        margin-top: 10px;
        width: 100%;
        align-items: center;
        padding: 0;
        flex-direction: column; /* Ensure column on small screens */
      }
      .header-search-group {
        justify-content: center;
        width: 100%;
      }
      .header-search-group input[type="text"] {
        width: calc(100% - 100px);
        max-width: 250px;
      }

      h1 {
        font-size: 2em;
      }
      h2 {
        font-size: 1.5em;
      }
      .games-container {
        gap: 20px;
      }
      .game {
        width: 180px;
      }
      #searchResults {
        margin-top: 10px;
      }
      .game-iframe-container {
        height: calc(100% - 120px);
        width: 98%;
      }
      .game-controls-bar {
        width: 98%;
        height: 80px;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
      }
      .game-controls-bar button {
        font-size: 0.8em;
        padding: 8px 15px;
      }
      .store-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      .more-link-item {
        width: 95%; /* Make it wider on smaller screens */
        padding: 15px;
      }
      #suggest-tab iframe {
        height: 400px; /* Adjust height for smaller screens */
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1.3em;
      }
      .game {
        width: 100%;
        max-width: 250px;
      }
      .color-picker-container {
        flex-direction: column;
        align-items: flex-start;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<!-- 3D Background Canvas -->
<canvas id="background3DCanvas"></canvas>

<header>
  <div class="header-content">
    <h1 data-i18n-key="homeTitle">EPIXGAMES Home 🎮</h1>
    <!-- This paragraph will now cycle through banner texts -->
    <p id="homeSubtitleText"></p>
  </div>
</header>

<!-- Tabs Navigation -->
<nav id="tabs-container">
  <button class="tab-button active" data-tab="games-tab" data-i18n-key="tabGames">Games</button>
  <button class="tab-button" data-tab="store-tab" data-i18n-key="tabStore">Store</button>
  <button class="tab-button" data-tab="suggest-tab" data-i18n-key="tabSuggest">Suggest</button>
  <button class="tab-button" data-tab="more-tab" data-i18n-key="tabMore">More</button>
  <button class="tab-button" data-tab="settings-tab" data-i18n-key="tabSettings">Settings</button>
</nav>

<!-- Tab Content -->
<div id="tab-content">
  <!-- Games Tab -->
  <div id="games-tab" class="tab-content active">
    <!-- Search Widget Container (now inside Games Tab) -->
    <div class="search-widget-container">
      <div class="header-search-group">
        <input type="text" id="searchInput" placeholder="Search games...">
        <button id="searchButton">Search</button>
      </div>
      <div id="searchResults" class="search-results"></div>
    </div>

    <h2 data-i18n-key="gamesSectionTitle">EPIXGAMES Games</h2>
    <div id="staticGamesContainer" class="games-container">
      <!-- Static games will be dynamically added by JavaScript here -->
    </div>

    <h2 id="customGamesTitle" style="display: none;">Custom Games ✨</h2>
    <div id="customGamesContainer" class="games-container" style="display: none;">
      <!-- Custom games will be dynamically loaded here -->
    </div>

  </div>

  <!-- Store Tab -->
  <div id="store-tab" class="tab-content">
    <h2 data-i18n-key="storeSectionTitle">EPIXGAMES Store 🛍️</h2>
    <!-- Changed data-i18n-key to a span inside the div -->
    <div class="money-display"><span data-i18n-key="yourMoneyPrefix">Money:</span> <span id="currentMoney">0</span> 💰</div>
    <div id="storeItemsContainer" class="store-grid">
      <!-- Store items will be dynamically loaded here -->
    </div>
  </div>

  <!-- Suggest Tab -->
  <div id="suggest-tab" class="tab-content">
    <h2 data-i18n-key="suggestSectionTitle">Suggest a Game or Feature! 💡</h2>
    <p data-i18n-key="suggestSubtitle">Got a lit idea for a new game or a feature that would make EPIXGAMES even more fire? Drop your suggestions here! 👇</p>
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSffflitG4a27clWulopftjmuGF6o1Pbl_6HkPWOzf4B-oczXw/viewform?usp=dialog" frameborder="0" marginheight="0" marginwidth="0">Loading…</iframe>
  </div>

  <!-- More Tab -->
  <div id="more-tab" class="tab-content">
    <h2 data-i18n-key="moreSectionTitle">More EPIX Content ✨</h2>
    <div class="more-links-container">
      <div class="more-link-item">
        <h3>BirdMath Classic (Before EPIXGAMES)</h3>
        <p data-i18n-key="birdMathClassicDesc">Relive the OG days with the classic BirdMath site! It's where it all began. 🐦</p>
        <a href="/play/classic/" target="_blank" data-i18n-key="visitLink">Visit Site</a>
      </div>
      <div class="more-link-item">
        <h3>MultiScreen Animation</h3>
        <p data-i18n-key="multiScreenAnimationDesc">Experience cool animations across multiple devices. Just press the number based on what order the device is in to have the illusion that something is moving across a screen. 📱➡️📱➡️📱</p>
        <a href="/screen/" target="_blank" data-i18n-key="visitLink">Visit Site</a>
      </div>
      <div class="more-link-item">
        <h3>BirdMath Local Minimal Browser</h3>
        <p data-i18n-key="minimalBrowserDesc">A lightweight browser with a bunch of pr0x1es. Not really recommended to use as it isn't maintained, but it's there if you're feeling nostalgic! 💾</p>
        <a href="/minilocal/" target="_blank" data-i18n-key="visitLink">Visit Site</a>
      </div>
      <div class="more-link-item">
        <h3>Proxser</h3>
        <p data-i18n-key="proxserDesc">A reliable pr0xy with tabs that works today. Get your browsing on! 🌐</p>
        <a href="https://proxser.pages.dev" target="_blank" data-i18n-key="visitLink">Visit Site</a>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div id="settings-tab" class="tab-content">
    <h2 data-i18n-key="settingsSectionTitle">Settings ⚙️</h2>

    <div class="settings-section">
      <label for="accentColorPicker" data-i18n-key="settingsAccentColor">Choose Accent Color:</label>
      <input type="color" id="accentColorPicker" value="#61dafb">
    </div>

    <div class="settings-section">
      <label for="languageSelect" data-i18n-key="settingsLanguage">Language:</label>
      <select id="languageSelect">
        <option value="en" data-i18n-key="langEnglish">English</option>
        <option value="es" data-i18n-key="langSpanish">Español</option>
        <option value="fr" data-i18n-key="langFrench">Français</option>
      </select>
    </div>

    <div class="settings-section">
      <label for="enable3DAnimation">Enable 3D Background Animation:</label>
      <input type="checkbox" id="enable3DAnimation">
    </div>

    <div class="settings-section">
      <label data-i18n-key="settingsManageHiddenGames">Manage Hidden Games:</label>
      <div id="hiddenGamesList" class="management-list">
        <!-- Hidden games will be rendered here -->
      </div>
    </div>

    <div class="settings-section">
      <label data-i18n-key="settingsManageFavoriteGames">Manage Favorite Games:</label>
      <div id="favoriteGamesList" class="management-list">
        <!-- Favorite games will be rendered here -->
      </div>
    </div>

    <div class="settings-section">
      <label data-i18n-key="settingsReset">Reset All Data:</label>
      <button id="resetEverythingButton" class="reset-button" data-i18n-key="resetButton">Reset Everything</button>
      <p id="resetConfirmationMessage" class="confirmation-message"></p>
    </div>
  </div>

</div>

<!-- Iframe Game Player Overlay -->
<div id="gamePlayerOverlay" class="game-player-overlay">
  <div class="game-iframe-container">
    <iframe id="gameIframe" class="game-iframe" allowfullscreen></iframe>
  </div>
  <div class="game-controls-bar">
    <button id="reloadGameButton" data-i18n-key="reloadButton">Reload</button>
    <button id="switchUrlButton" data-i18n-key="switchUrlButton">Switch URL</button>
    <button id="fullScreenButton" data-i18n-key="fullScreenButton">Full Screen</button>
    <button id="exitGameButton" data-i18n-key="exitButton">Exit</button>
    <button id="copyLinkButton" data-i18n-key="copyLink보다">Copy Link</button>
  </div>
</div>

<!-- Custom Message Box -->
<div id="messageBox">
  <p id="messageBoxText"></p>
  <button id="messageBoxCloseButton">OK</button>
</div>

<!-- Custom Right-Click Context Menu -->
<div id="gameContextMenu" class="context-menu">
  <div class="context-menu-item" id="contextMenuHide">Hide Game</div>
  <div class="context-menu-item" id="contextMenuToggleFavorite">Favorite / Unfavorite</div>
</div>

<!-- Command Prompt Overlay -->
<div id="commandPromptOverlay">
  <div id="console">
    <div id="consoleOutput"></div>
    <input type="text" id="commandInput" placeholder="Type 'HELP' for commands..." autofocus>
  </div>
</div>

<!-- Hidden file input for theme/settings import -->
<input type="file" id="fileInput" style="display: none;" accept=".json, .html">


<script>
  // Define the base URLs for the games
  const GAME_BASE_URLS = [
    'https://epix.pages.dev',
    'https://birdmath.vercel.app',
    'https://birdmath-yqlov.kinsta.page',
    'https://birdmath-fidgetsetcs-projects.vercel.app',
    'https://birdmath-git-main-fidgetsetcs-projects.vercel.app',
    'https://lustrous-horse-7c8ec9.netlify.app',
    'https://coolmathgames-4gyl5.kinsta.page',
    'https://friend-b14n3.kinsta.page',
    'https://a-c2tq2.kinsta.page'
  ];

  // Translations for internationalization
  const translations = {
    en: {
      homeTitle: "EPIXGAMES Home �",
      tabGames: "Games",
      tabStore: "Store",
      tabSettings: "Settings",
      tabMore: "More",
      tabSuggest: "Suggest",
      gamesSectionTitle: "EPIXGAMES Games",
      customGamesSectionTitle: "Custom Games ✨", // New translation
      storeSectionTitle: "EPIXGAMES Store 🛍️",
      yourMoneyPrefix: "Money:",
      settingsSectionTitle: "Settings ⚙️",
      settingsAccentColor: "Choose Accent Color:",
      settingsLanguage: "Language:",
      langEnglish: "English",
      langSpanish: "Español",
      langFrench: "Français",
      settingsReset: "Reset All Data:",
      resetButton: "Reset Everything",
      reloadButton: "Reload",
      switchUrlButton: "Switch URL",
      fullScreenButton: "Full Screen",
      exitButton: "Exit",
      copyLinkButton: "Copy Link",
      buyButton: "Buy for {cost} 💰",
      applyButton: "Apply",
      appliedText: "Applied!",
      ownedText: "Owned",
      insufficientFunds: "Not enough money!",
      resetConfirm: "Are you sure? Click {count} more times to confirm!",
      resetFinalConfirm: "All data reset! Reloading...",
      linkCopied: "Game link copied to clipboard!",
      searchPlaceholder: "Search games...",
      moreSectionTitle: "More EPIX Content ✨",
      birdMathClassicDesc: "Relive the OG days with the classic BirdMath site! It's where it all began. 🐦",
      multiScreenAnimationDesc: "Experience cool animations across multiple devices. Just press the number based on what order the device is in to have the illusion that something is moving across a screen. 📱➡️📱➡️📱",
      minimalBrowserDesc: "A lightweight browser with a bunch of pr0x1es. Not really recommended to use as it isn't maintained, but it's there if you're feeling nostalgic! 💾",
      proxserDesc: "A reliable pr0xy with tabs that works today. Get your browsing on! 🌐",
      visitLink: "Visit Site",
      suggestSectionTitle: "Suggest a Game or Feature! 💡",
      suggestSubtitle: "Got a lit idea for a new game or a feature that would make EPIXGAMES even more fire? Drop your suggestions here! 👇",
      bannerTexts: [ // These texts will now cycle in the subtitle area
        "Play games, earn money! 💰",
        "Customize your vibe! Shop themes now! ✨",
        "Unlock 3D animations & custom colors in Settings! ⚙️",
        "Chrome 55 compatible?! That's retro cool! 🚀",
        "We just got a MAJOR upgrade to the site, fam! Get ready for some epic gaming! 😎" // Original subtitle added here
      ],
      // New translations for hidden/favorite games
      settingsManageHiddenGames: "Manage Hidden Games:",
      settingsManageFavoriteGames: "Manage Favorite Games:",
      hideGameText: "Hide Game",
      unhideGameText: "Unhide",
      favoriteGameText: "Favorite",
      unfavoriteGameText: "Unfavorite",
      gameHidden: "Game hidden!",
      gameUnhidden: "Game unhidden!",
      gameFavorited: "Game added to favorites! ⭐",
      gameUnfavorited: "Game removed from favorites.",
      playNowButton: "Play Now", // Added for consistency

      // Command prompt translations
      cmdHelp: `Available Commands:
  EXIT: Close the command prompt.
  HELP: Display this help message.
  MONEY_ADD #: Add money. Example: MONEY_ADD 100
  MONEY_REMOVE #: Remove money. Example: MONEY_REMOVE 50
  MONEY_SET #: Set money to a specific amount. Example: MONEY_SET 1000
  IFRAME_OPEN <url>: Open a webpage in the game iframe. Example: IFRAME_OPEN https://example.com
  SEQUENCE_ADD: Start recording a new command sequence.
  SEQUENCE_DO <name>: Execute a saved command sequence.
  GAME_ADD: Add a new game to the list.
  GAME_SHOW_CUSTOM: Toggle visibility of custom games.
  THEME_CREATE: Create and save a custom theme.
  THEME_ADD: Import a custom theme from a file.
  THEME_EXPORT: Export all custom themes to a file.
  HTML_MODIFY: Apply custom CSS modifications to elements.
  HTML_MODIFY_OPEN: View saved HTML modifications.
  HTML_MODIFY_EXPORT: Export the current page HTML with modifications.
  SETTINGS_EXPORT: Export all settings to a file.
  SETTINGS_IMPORT: Import settings from a file.
  CUSTOM_SETTINGS: Create a custom settings file by providing values.`,
      cmdExit: "Exiting command prompt.",
      cmdMoneyAdded: "Added {amount} money. New balance: {balance}💰",
      cmdMoneyRemoved: "Removed {amount} money. New balance: {balance}💰",
      cmdMoneySet: "Money set to {balance}💰",
      cmdInvalidAmount: "Invalid amount. Please provide a number.",
      cmdIframeOpened: "Opening {url} in game iframe.",
      cmdInvalidUrl: "Invalid URL. Please provide a valid URL.",
      cmdSequenceAddStart: "Enter sequence name:",
      cmdSequenceAddRecording: "Recording sequence '{name}'. Enter commands one by one. Type 'END_SEQUENCE' to finish.",
      cmdSequenceAddEnd: "Sequence '{name}' saved with {count} commands.",
      cmdSequenceAddCancelled: "Sequence recording cancelled.",
      cmdSequenceNotFound: "Sequence '{name}' not found.",
      cmdSequenceExecuting: "Executing sequence '{name}'...",
      cmdUnknownCommand: "Unknown command: '{command}'. Type 'HELP' for a list of commands.",
      cmdSequenceNameExists: "Sequence '{name}' already exists. Choose a different name or use SEQUENCE_DO to run it.",
      cmdNoSequenceToRecord: "No sequence name provided. Recording cancelled.",
      cmdGameAddTitle: "Enter game title:",
      cmdGameAddImage: "Enter image URL for the game:",
      cmdGameAddPath: "Enter game path (e.g., /play/mygame.html):",
      cmdGameAdded: "Game '{title}' added successfully!",
      cmdGameShowCustomToggled: "Custom games visibility toggled.", // New translation
      cmdThemeCreateName: "Enter new theme name:",
      cmdThemeCreatePrimary: "Enter primary color (hex, e.g., #RRGGBB):",
      cmdThemeCreateSecondary: "Enter secondary color (hex):",
      cmdThemeCreateBg: "Enter background color (hex):",
      cmdThemeCreateText: "Enter text color (hex):",
      cmdThemeCreateCardBg: "Enter card background color (hex):",
      cmdThemeCreateButtonBg: "Enter button background color (hex):",
      cmdThemeCreated: "Theme '{name}' created and added to store!",
      cmdThemeAddPrompt: "Select a theme JSON file to import.",
      cmdThemeAdded: "Theme '{name}' imported successfully!",
      cmdThemeAddError: "Failed to import theme: {error}",
      cmdThemeExported: "Custom themes exported as 'epixgames_custom_themes.json'.", // New translation
      cmdHtmlModifySelector: "Enter CSS selector (e.g., body, .header-content p):",
      cmdHtmlModifyProperty: "Enter CSS property (e.g., background-color, font-size):",
      cmdHtmlModifyValue: "Enter CSS value (e.g., red, 20px !important):",
      cmdHtmlModified: "HTML modification applied and saved!",
      cmdHtmlModifyList: "Saved HTML Modifications:",
      cmdHtmlModifyNone: "No HTML modifications saved.",
      cmdHtmlModifyOpenSelect: "Enter the index of the modification to view:",
      cmdHtmlModifyOpenInvalid: "Invalid index. Please enter a valid number.",
      cmdHtmlModifyExported: "Current HTML exported as 'epixgames_site.html'.",
      cmdSettingsExported: "All settings exported as 'epixgames_settings.json'.",
      cmdSettingsImportPrompt: "Select a settings JSON file to import.",
      cmdSettingsImported: "Settings imported successfully! Reloading page...",
      cmdSettingsImportError: "Failed to import settings: {error}",
      cmdFileReadError: "Error reading file: {error}",
      cmdInvalidColor: "Invalid color format. Please use hex (e.g., #RRGGBB).",
      // New translations for CUSTOM_SETTINGS creation
      cmdCustomSettingsMoneyPrompt: "Enter desired money amount (number):",
      cmdCustomSettingsLanguagePrompt: "Enter desired language (en, es, fr):",
      cmdCustomSettings3DAnimationPrompt: "Enable 3D background animation? (true/false):",
      cmdInvalidLanguage: "Invalid language. Please enter 'en', 'es', or 'fr'.",
      cmdInvalidBoolean: "Invalid input. Please enter 'true' or 'false'.",
      cmdCustomSettingsFileCreated: "Custom settings file 'epixgames_custom_user_settings.json' created. You can import it using 'SETTINGS_IMPORT'."
    },
    es: {
      homeTitle: "EPIXJUEGOS Inicio 🎮",
      tabGames: "Juegos",
      tabStore: "Tienda",
      tabSettings: "Ajustes",
      tabMore: "Más",
      tabSuggest: "Sugerir",
      gamesSectionTitle: "Juegos EPIXGAMES",
      customGamesSectionTitle: "Juegos Personalizados ✨",
      storeSectionTitle: "Tienda EPIXGAMES 🛍️",
      yourMoneyPrefix: "Dinero:",
      settingsSectionTitle: "Ajustes ⚙️",
      settingsAccentColor: "Elige Color de Acento:",
      settingsLanguage: "Idioma:",
      langEnglish: "Inglés",
      langSpanish: "Español",
      langFrench: "Francés",
      settingsReset: "Restablecer Todos los Datos:",
      resetButton: "Restablecer Todo",
      reloadButton: "Recargar",
      switchUrlButton: "Cambiar URL",
      fullScreenButton: "Pantalla Completa",
      exitButton: "Salir",
      copyLinkButton: "Copiar Enlace",
      buyButton: "Comprar por {cost} 💰",
      applyButton: "Aplicar",
      ownedText: "Poseído",
      insufficientFunds: "¡Dinero insuficiente!",
      resetConfirm: "¿Estás seguro? ¡Haz clic {count} veces más para confirmar!",
      resetFinalConfirm: "¡Todos los datos restablecidos! Recargando...",
      linkCopied: "¡Enlace del juego copiado!",
      searchPlaceholder: "Buscar juegos...",
      moreSectionTitle: "Más Contenido EPIX ✨",
      birdMathClassicDesc: "¡Revive los días de antaño con el sitio clásico de BirdMath! ¡Aquí es donde todo comenzó! 🐦",
      multiScreenAnimationDesc: "Experimenta animaciones geniales en múltiples dispositivos. Simplemente presiona el número según el orden del dispositivo para tener la ilusión de que algo se mueve por la pantalla. 📱➡️📱➡️📱",
      minimalBrowserDesc: "Un navegador ligero con varios proxies. No se recomienda mucho su uso ya que no se mantiene, ¡pero está ahí si sientes nostalgia! 💾",
      proxserDesc: "Un proxy fiable con pestañas que funciona hoy. ¡A navegar! 🌐",
      visitLink: "Visitar Sitio",
      suggestSectionTitle: "¡Sugiere un Juego o Característica! 💡",
      suggestSubtitle: "¿Tienes una idea genial para un nuevo juego o una característica que haría EPIXGAMES aún más increíble? ¡Deja tus sugerencias aquí! 👇",
      bannerTexts: [
        "¡Juega, gana dinero! 💰",
        "¡Personaliza tu estilo! ¡Compra temas ahora! ✨",
        "¡Desbloquea animaciones 3D y colores personalizados en Ajustes! ⚙️",
        "¿Compatible con Chrome 55? ¡Eso es genial! 🚀",
        "¡Acabamos de actualizar el sitio, familia! ¡Prepárense para juegos épicos! 😎"
      ],
      settingsManageHiddenGames: "Administrar Juegos Ocultos:",
      settingsManageFavoriteGames: "Administrar Juegos Favoritos:",
      hideGameText: "Ocultar Juego",
      unhideGameText: "Mostrar",
      favoriteGameText: "Favorito",
      unfavoriteGameText: "Quitar de Favoritos",
      gameHidden: "¡Juego oculto!",
      gameUnhidden: "¡Juego visible!",
      gameFavorited: "¡Juego añadido a favoritos! ⭐",
      gameUnfavorited: "Juego eliminado de favoritos.",
      playNowButton: "Jugar Ahora",

      // Command prompt translations
      cmdHelp: `Comandos Disponibles:
  EXIT: Cerrar la consola de comandos.
  HELP: Mostrar este mensaje de ayuda.
  MONEY_ADD #: Añadir dinero. Ejemplo: MONEY_ADD 100
  MONEY_REMOVE #: Eliminar dinero. Ejemplo: MONEY_REMOVE 50
  MONEY_SET #: Establecer dinero a una cantidad específica. Ejemplo: MONEY_SET 1000
  IFRAME_OPEN <url>: Abrir una página web en el iframe del juego. Ejemplo: IFRAME_OPEN https://example.com
  SEQUENCE_ADD: Empezar a grabar una nueva secuencia de comandos.
  SEQUENCE_DO <nombre>: Ejecutar una secuencia de comandos guardada.
  GAME_ADD: Añadir un nuevo juego a la lista.
  GAME_SHOW_CUSTOM: Alternar visibilidad de juegos personalizados.
  THEME_CREATE: Crear y guardar un tema personalizado.
  THEME_ADD: Importar un tema personalizado desde un archivo.
  THEME_EXPORT: Exportar todos los temas personalizados a un archivo.
  HTML_MODIFY: Aplicar modificaciones CSS personalizadas a elementos.
  HTML_MODIFY_OPEN: Ver modificaciones HTML guardadas.
  HTML_MODIFY_EXPORT: Exportar el HTML actual de la página con modificaciones.
  SETTINGS_EXPORT: Exportar todos los ajustes a un archivo.
  SETTINGS_IMPORT: Importar ajustes desde un archivo.
  CUSTOM_SETTINGS: Crear un archivo de ajustes personalizados proporcionando valores.`,
      cmdExit: "Saliendo de la consola de comandos.",
      cmdMoneyAdded: "Se añadió {amount} dinero. Saldo actual: {balance}💰",
      cmdMoneyRemoved: "Se eliminó {amount} dinero. Saldo actual: {balance}💰",
      cmdMoneySet: "Dinero establecido en {balance}💰",
      cmdInvalidAmount: "Cantidad inválida. Por favor, proporciona un número.",
      cmdIframeOpened: "Abriendo {url} en el iframe del juego.",
      cmdInvalidUrl: "URL inválida. Por favor, proporciona una URL válida.",
      cmdSequenceAddStart: "Introduce el nombre de la secuencia:",
      cmdSequenceAddRecording: "Grabando secuencia '{name}'. Introduce comandos uno por uno. Escribe 'END_SEQUENCE' para finalizar.",
      cmdSequenceAddEnd: "Secuencia '{name}' guardada con {count} comandos.",
      cmdSequenceAddCancelled: "Grabación de secuencia cancelada.",
      cmdSequenceNotFound: "Secuencia '{name}' no encontrada.",
      cmdSequenceExecuting: "Ejecutando secuencia '{name}'...",
      cmdUnknownCommand: "Comando desconocido: '{command}'. Escribe 'HELP' para ver la lista de comandos.",
      cmdSequenceNameExists: "La secuencia '{name}' ya existe. Elige un nombre diferente o usa SEQUENCE_DO para ejecutarla.",
      cmdNoSequenceToRecord: "No se proporcionó nombre de secuencia. Grabación cancelada.",
      cmdGameAddTitle: "Introduce el título del juego:",
      cmdGameAddImage: "Introduce la URL de la imagen para el juego:",
      cmdGameAddPath: "Introduce la ruta del juego (ej. /play/mi-juego.html):",
      cmdGameAdded: "¡Juego '{title}' añadido con éxito!",
      cmdGameShowCustomToggled: "Visibilidad de juegos personalizados alternada.",
      cmdThemeCreateName: "Introduce el nombre del nuevo tema:",
      cmdThemeCreatePrimary: "Introduce el color principal (hex, ej. #RRGGBB):",
      cmdThemeCreateSecondary: "Introduce el color secundario (hex):",
      cmdThemeCreateBg: "Introduce el color de fondo (hex):",
      cmdThemeCreateText: "Introduce el color del texto (hex):",
      cmdThemeCreateCardBg: "Introduce el color de fondo de la tarjeta (hex):",
      cmdThemeCreateButtonBg: "Introduce el color de fondo del botón (hex):",
      cmdThemeCreated: "¡Tema '{name}' creado y añadido a la tienda!",
      cmdThemeAddPrompt: "Selecciona un archivo JSON de tema para importar.",
      cmdThemeAdded: "¡Tema '{name}' importado con éxito!",
      cmdThemeAddError: "Error al importar el tema: {error}",
      cmdThemeExported: "Temas personalizados exportados como 'epixgames_custom_themes.json'.",
      cmdHtmlModifySelector: "Introduce el selector CSS (ej. body, .header-content p):",
      cmdHtmlModifyProperty: "Introduce la propiedad CSS (ej. background-color, font-size):",
      cmdHtmlModifyValue: "Introduce el valor CSS (ej. red, 20px !important):",
      cmdHtmlModified: "¡Modificación HTML aplicada y guardada!",
      cmdHtmlModifyList: "Modificaciones HTML Guardadas:",
      cmdHtmlModifyNone: "No hay modificaciones HTML guardadas.",
      cmdHtmlModifyOpenSelect: "Introduce el índice de la modificación a ver:",
      cmdHtmlModifyOpenInvalid: "Índice inválido. Por favor, introduce un número válido.",
      cmdHtmlModifyExported: "HTML actual exportado como 'epixgames_site.html'.",
      cmdSettingsExported: "Todos los ajustes exportados como 'epixgames_settings.json'.",
      cmdSettingsImportPrompt: "Selecciona un archivo JSON de ajustes para importar.",
      cmdSettingsImported: "¡Ajustes importados con éxito! Recargando página...",
      cmdSettingsImportError: "Error al importar los ajustes: {error}",
      cmdFileReadError: "Error al leer el archivo: {error}",
      cmdInvalidColor: "Formato de color inválido. Por favor, usa hexadecimal (ej. #RRGGBB).",
      cmdCustomSettingsMoneyPrompt: "Introduce la cantidad de dinero deseada (número):",
      cmdCustomSettingsLanguagePrompt: "Introduce el idioma deseado (en, es, fr):",
      cmdCustomSettings3DAnimationPrompt: "¿Habilitar animación de fondo 3D? (true/false):",
      cmdInvalidLanguage: "Idioma inválido. Por favor, introduce 'en', 'es' o 'fr'.",
      cmdInvalidBoolean: "Entrada inválida. Por favor, introduce 'true' o 'false'.",
      cmdCustomSettingsFileCreated: "Archivo de ajustes personalizados 'epixgames_custom_user_settings.json' creado. Puedes importarlo usando 'SETTINGS_IMPORT'."
    },
    fr: {
      homeTitle: "EPIXJEUX Accueil 🎮",
      tabGames: "Jeux",
      tabStore: "Boutique",
      tabSettings: "Paramètres",
      tabMore: "Plus",
      tabSuggest: "Suggérer",
      gamesSectionTitle: "Jeux EPIXGAMES",
      customGamesSectionTitle: "Jeux Personnalisés ✨",
      storeSectionTitle: "Boutique EPIXGAMES 🛍️",
      yourMoneyPrefix: "Argent :",
      settingsSectionTitle: "Paramètres ⚙️",
      settingsAccentColor: "Choisir la Couleur d'Accentuation :",
      settingsLanguage: "Langue :",
      langEnglish: "Anglais",
      langSpanish: "Español",
      langFrench: "Français",
      settingsReset: "Réinitialiser Toutes les Données :",
      resetButton: "Tout Réinitialiser",
      reloadButton: "Recharger",
      switchUrlButton: "Changer l'URL",
      fullScreenButton: "Plein Écran",
      exitButton: "Quitter",
      copyLinkButton: "Copier le Lien",
      buyButton: "Acheter pour {cost} 💰",
      applyButton: "Appliquer",
      appliedText: "Appliqué !",
      ownedText: "Possédé",
      insufficientFunds: "Pas assez d'argent !",
      resetConfirm: "Êtes-vous sûr ? Cliquez {count} fois de plus para confirmer !",
      resetFinalConfirm: "Toutes les données réinitialisées ! Rechargement...",
      linkCopied: "Lien du jeu copié !",
      searchPlaceholder: "Rechercher des jeux...",
      moreSectionTitle: "Plus de Contenu EPIX ✨",
      birdMathClassicDesc: "Revivez les jours OG avec le site classique de BirdMath ! C'est là que tout a commencé. 🐦",
      multiScreenAnimationDesc: "Découvrez des animations sympas sur plusieurs appareils. Appuyez simplement sur le numéro en fonction de l'ordre de l'appareil pour avoir l'illusion que quelque chose se déplace sur un écran. 📱➡️📱➡️📱",
      minimalBrowserDesc: "Un navigateur léger avec un tas de proxys. Il n'est pas vraiment recommandé de l'utiliser car il n'est pas maintenu, mais il est là si vous êtes nostalgique ! 💾",
      proxserDesc: "Un proxy fiable avec des onglets qui fonctionne aujourd'hui. Naviguez ! 🌐",
      visitLink: "Visiter le Site",
      suggestSectionTitle: "Suggérer un Jeu ou une Fonctionnalité ! 💡",
      suggestSubtitle: "Vous avez une idée géniale pour un nouveau jeu ou une fonctionnalité qui rendrait EPIXGAMES encore plus génial ? Laissez vos suggestions ici ! 👇",
      bannerTexts: [
        "Jouez, gagnez de l'argent ! 💰",
        "Personalisez votre style ! Achetez des thèmes maintenant ! ✨",
        "Débloquez des animations 3D et des couleurs personnalisées dans les paramètres ! ⚙️",
        "Compatible Chrome 55 ?! C'est trop cool ! 🚀",
        "On a fait une GROSSE mise a jour du site, la famille ! Préparez-vous pour des jeux épiques ! 😎"
      ],
      settingsManageHiddenGames: "Gérer les Jeux Cachés :",
      settingsManageFavoriteGames: "Gérer les Jeux Favoris :",
      hideGameText: "Cacher le Jeu",
      unhideGameText: "Afficher",
      favoriteGameText: "Favori",
      unfavoriteGameText: "Retirer des Favoris",
      gameHidden: "Jeu caché !",
      gameUnhidden: "Jeu affiché !",
      gameFavorited: "Jeu ajouté aux favoris ! ⭐",
      gameUnfavorited: "Jeu retiré des favoris.",
      playNowButton: "Jouer Maintenant",

      // Command prompt translations
      cmdHelp: `Commandes Disponibles :
  EXIT: Fermer l'invite de commande.
  HELP: Afficher ce message d'aide.
  MONEY_ADD #: Ajouter de l'argent. Exemple : MONEY_ADD 100
  MONEY_REMOVE #: Supprimer de l'argent. Exemple : MONEY_REMOVE 50
  MONEY_SET #: Définir l'argent à un montant spécifique. Exemple : MONEY_SET 1000
  IFRAME_OPEN <url>: Ouvrir une page web dans l'iframe du jeu. Exemple : IFRAME_OPEN https://example.com
  SEQUENCE_ADD: Commencer l'enregistrement d'une nouvelle séquence de commandes.
  SEQUENCE_DO <nom>: Exécuter une séquence de commandes enregistrée.
  GAME_ADD: Ajouter un nouveau jeu à la liste.
  GAME_SHOW_CUSTOM: Basculer la visibilité des jeux personnalisés.
  THEME_CREATE: Créer et sauvegarder un thème personnalisé.
  THEME_ADD: Importer un thème personnalisé à partir d'un fichier.
  THEME_EXPORT: Exporter tous les thèmes personnalisés vers un fichier.
  HTML_MODIFY: Appliquer des modifications CSS personnalisées aux éléments.
  HTML_MODIFY_OPEN: Afficher les modifications HTML enregistrées.
  HTML_MODIFY_EXPORT: Exporter le HTML actuel de la page avec les modifications.
  SETTINGS_EXPORT: Exporter tous les paramètres dans un fichier.
  SETTINGS_IMPORT: Importer les paramètres à partir d'un fichier.
  CUSTOM_SETTINGS: Créer un fichier de paramètres personnalisés en fournissant des valeurs.`,
      cmdExit: "Fermeture de l'invite de commande.",
      cmdMoneyAdded: "Ajout de {amount} argent. Nouveau solde : {balance}💰",
      cmdMoneyRemoved: "Suppression de {amount} argent. Nouveau solde : {balance}💰",
      cmdMoneySet: "Argent défini à {balance}💰",
      cmdInvalidAmount: "Montant invalide. Veuillez fournir un nombre.",
      cmdIframeOpened: "Ouverture de {url} dans l'iframe du jeu.",
      cmdInvalidUrl: "URL invalide. Veuillez fournir une URL valide.",
      cmdSequenceAddStart: "Entrez le nom de la séquence :",
      cmdSequenceAddRecording: "Enregistrement de la séquence '{name}'. Entrez les commandes une par une. Tapez 'END_SEQUENCE' pour terminer.",
      cmdSequenceAddEnd: "Séquence '{name}' enregistrée avec {count} commandes.",
      cmdSequenceAddCancelled: "Enregistrement de la séquence annulé.",
      cmdSequenceNotFound: "Séquence '{name}' introuvable.",
      cmdSequenceExecuting: "Exécution de la séquence '{name}'...",
      cmdUnknownCommand: "Commande inconnue : '{command}'. Tapez 'HELP' pour la liste des commandes.",
      cmdSequenceNameExists: "La séquence '{name}' existe déjà. Choisissez un nom différent ou utilisez SEQUENCE_DO pour l'exécuter.",
      cmdNoSequenceToRecord: "Aucun nom de séquence fourni. Enregistrement annulé.",
      cmdGameAddTitle: "Entrez le titre du jeu :",
      cmdGameAddImage: "Entrez l'URL de l'image pour le jeu :",
      cmdGameAddPath: "Entrez le chemin du jeu (ex. /play/mon-jeu.html) :",
      cmdGameAdded: "Jeu '{title}' ajouté avec succès !",
      cmdGameShowCustomToggled: "Visibilité des jeux personnalisés basculée.",
      cmdThemeCreateName: "Entrez le nom du nouveau thème :",
      cmdThemeCreatePrimary: "Entrez la couleur principale (hex, ex. #RRGGBB) :",
      cmdThemeCreateSecondary: "Entrez la couleur secondaire (hex) :",
      cmdThemeCreateBg: "Entrez la couleur de fond (hex) :",
      cmdThemeCreateText: "Entrez la couleur du texto (hex) :",
      cmdThemeCreateCardBg: "Entrez la couleur de fond de la carte (hex) :",
      cmdThemeCreateButtonBg: "Entrez la couleur de fond du bouton (hex) :",
      cmdThemeCreated: "Thème '{name}' créé et ajouté à la boutique !",
      cmdThemeAddPrompt: "Sélectionnez un fichier JSON de thème à importer.",
      cmdThemeAdded: "Thème '{name}' importé avec succès !",
      cmdThemeAddError: "Échec de l'importation du thème : {error}",
      cmdThemeExported: "Thèmes personnalisés exportés sous 'epixgames_custom_themes.json'.",
      cmdHtmlModifySelector: "Entrez le sélecteur CSS (ex. body, .header-content p) :",
      cmdHtmlModifyProperty: "Entrez la propriété CSS (ex. background-color, font-size) :",
      cmdHtmlModifyValue: "Entrez le valeur CSS (ex. red, 20px !important) :",
      cmdHtmlModified: "Modification HTML appliquée et enregistrée !",
      cmdHtmlModifyList: "Modificaciones HTML Enregistrées :",
      cmdHtmlModifyNone: "Aucune modification HTML enregistrée.",
      cmdHtmlModifyOpenSelect: "Entrez l'index de la modification à afficher :",
      cmdHtmlModifyOpenInvalid: "Index invalide. Veuillez entrer un numéro valide.",
      cmdHtmlModifyExported: "HTML actuel exporté sous 'epixgames_site.html'.",
      cmdSettingsExported: "Tous les paramètres exportés sous 'epixgames_settings.json'.",
      cmdSettingsImportPrompt: "Sélectionnez un fichier JSON de paramètres à importer.",
      cmdSettingsImported: "Paramètres importés con éxito ! Rechargement de la page...",
      cmdSettingsImportError: "Échec de l'importation des paramètres : {error}",
      cmdFileReadError: "Erreur de lecture du fichier : {error}",
      cmdInvalidColor: "Format de couleur inválido. Veuillez utiliser l'hexadécimal (ex. #RRGGBB).",
      cmdCustomSettingsMoneyPrompt: "Entrez le montant d'argent désiré (nombre) :",
      cmdCustomSettingsLanguagePrompt: "Entrez la langue désirée (en, es, fr) :",
      cmdCustomSettings3DAnimationPrompt: "Activer l'animation de fond 3D ? (true/false) :",
      cmdInvalidLanguage: "Langue invalide. Veuillez entrer 'en', 'es' ou 'fr'.",
      cmdInvalidBoolean: "Entrée invalide. Veuillez entrer 'true' ou 'false'.",
      cmdCustomSettingsFileCreated: "Fichier de paramètres personnalisés 'epixgames_custom_user_settings.json' créé. Vous pouvez l'importer en utilisant 'SETTINGS_IMPORT'."
    }
  };


  // Store items data
  const storeItems = [
    { id: 'bg-stars', name: 'Starry Night', type: 'background', value: 'url(https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg/500px-Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg) no-repeat center center / cover', cost: 50, default: false, img: 'https://placehold.co/100x100/000033/FFFFFF?text=Stars' },
    { id: 'bg-neon', name: 'Neon Grid', type: 'background', value: 'url(https://static.vecteezy.com/system/resources/previews/020/562/054/non_2x/background-of-neon-grid-for-retro-futuristic-design-vector.jpg) no-repeat center center / cover', cost: 75, default: false, img: 'https://placehold.co/100x100/330033/FF00FF?text=Neon' },
    { id: 'text-gold', name: 'Gold Text', type: 'text-color', value: 'gold', cost: 30, default: false, img: 'https://placehold.co/100x100/3c4048/FFD700?text=Gold' },
    { id: 'text-lime', name: 'Lime Text', type: 'text-color', value: 'lime', cost: 30, default: false, img: 'https://placehold.co/100x100/3c4048/00FF00?text=Lime' },
    { id: 'bg-gumball', name: 'The Amazing World of Gumball Theme', type: 'background', value: 'url(https://images6.alphacoders.com/950/950030.jpg) no-repeat center center / cover', cost: 20, default: false, img: 'https://placehold.co/100x100/4CAF50/FFFFFF?text=Gumball' },
    { id: 'bg-minecraft', name: 'Minecraft Theme', type: 'background', value: 'url(https://wallpapers.com/images/featured/minecraft-s2kxfahyg30sob8q.jpg) no-repeat center center / cover', cost: 15, default: false, img: 'https://placehold.co/100x100/8BC34A/FFFFFF?text=Minecraft' },
    { id: 'bg-amongus', name: 'Among Us Theme', type: 'background', value: 'url(https://i.redd.it/jo89zfzqi9t51.png) no-repeat center center / cover', cost: 10, default: false, img: 'https://placehold.co/100x100/FF5722/FFFFFF?text=AmongUs' },
    { id: 'default-theme', name: 'Default Theme', type: 'full-theme', value: {
      '--home-background': '#282c34',
      '--home-text-color': '#ffffff'
    }, cost: 0, default: true, img: 'https://placehold.co/100x100/282c34/FFFFFF?text=Default' },
    { id: 'rgb-theme', name: 'RGB Theme', type: 'dynamic-theme', value: {}, cost: 70, default: false, img: 'https://placehold.co/100x100/FF00FF/00FFFF?text=RGB' },
    { id: 'classic-theme', name: 'Classic EPIXGAMES Theme', type: 'full-theme', value: {
      '--home-background': '#4287f5',
      '--home-text-color': '#ffffff',
      '--bg-color': '#4287f5', /* Used for tab/card background, will be overridden by !important */
      '--primary-color': '#007bff',
      '--secondary-color': '#007bff',
      '--card-bg': 'transparent', /* Will be overridden by !important */
      '--button-bg': '#007bff',
      '--button-hover-bg': '#0056b3'
    }, cost: 40, default: false, img: 'https://placehold.co/100x100/4287f5/FFFFFF?text=Classic' }
  ];


  // Global variables
  let currentBaseUrl = GAME_BASE_URLS[0];
  let money = parseInt(localStorage.getItem('epixgamesMoney') || '0');
  let ownedAccessories = JSON.parse(localStorage.getItem('epixgamesOwnedAccessories') || '{}');
  let appliedAccessory = localStorage.getItem('epixgamesAppliedAccessory') || 'default-theme';
  let currentLanguage = localStorage.getItem('epixgamesLanguage') || 'en';
  let totalPlaytimeSeconds = parseInt(localStorage.getItem('epixgamesTotalPlaytimeSeconds') || '0'); // New: total accumulated playtime
  let sessionStartTime = 0; // New: timestamp for current session start
  let moneyInterval = null;
  let resetConfirmCount = 0;
  let resetConfirmTimeout = null;
  let rgbIntervalId = null; // New: for RGB theme interval
  let currentHue = 0; // New: for RGB theme color cycling
  let bannerTextIndex = 0; // New: for cycling banner text
  let bannerIntervalId = null; // New: for banner text interval
  let currentLoadedGamePath = ''; // To keep track of the currently loaded game path

  // Three.js related global variables
  let scene, camera, renderer, animationObjects = [];
  let isAnimationEnabled = JSON.parse(localStorage.getItem('epixgames3DAnimationEnabled') || 'false');
  let animationFrameId = null; // To store the requestAnimationFrame ID for stopping animation

  // Command prompt related global variables
  let isCommandPromptOpen = false;
  let keyState = {}; // To track pressed keys for opening command prompt
  let sequences = JSON.parse(localStorage.getItem('epixgamesCommandSequences') || '{}');
  // Explicitly attach customGames and customThemes to window
  window.customGames = JSON.parse(localStorage.getItem('epixgamesCustomGames') || '[]'); // New: Store custom games
  window.customThemes = JSON.parse(localStorage.getItem('epixgamesCustomThemes') || '[]'); // New: Store custom themes
  let htmlModifications = JSON.parse(localStorage.getItem('epixgamesHtmlModifications') || '[]'); // New: Store HTML modifications

  let commandPromptState = {
      mode: 'normal', // 'normal', 'awaiting_sequence_name', 'recording_commands', 'awaiting_game_input', 'awaiting_theme_input', 'awaiting_html_modify_input', 'awaiting_custom_settings_input'
      subMode: '', // 'title', 'image', 'path' for game; 'name', 'primary', 'secondary', etc. for theme; 'selector', 'property', 'value' for html modify; 'money', 'language', 'animation3D' for custom settings
      data: {} // Temporary data for the current multi-step operation
  };

  // Global variable to store static game definitions
  window.staticGameDefinitions = [
    { id: 'game-1v1-lol', name: '1v1.lol', img: 'https://www.mediafire.com/convkey/0fba/fjsl0ca42p00o9m7g.jpg', path: '/play/1v1lol.html' },
    { id: 'game-Angry-Birds', name: 'Angry Birds', img: 'https://www.mediafire.com/convkey/ceef/iy0vghjso78nenc7g.jpg', path: '/play/angrybird.html' },
    { id: 'game-Angry-Birds-Epic', name: 'Angry Birds Epic', img: 'https://www.mediafire.com/convkey/13ce/zw7q7l17htz3iug7g.jpg', path: '/play/abepic.html' },
    { id: 'game-Among-Us', name: 'Among Us', img: 'https://www.mediafire.com/convkey/c9b4/dgoer8eo7sp7mnt7g.jpg', path: '/play/amongus.html' },
    { id: 'game-Angry-Birds-Rio', name: 'Angry Birds Rio', img: 'https://www.mediafire.com/convkey/c4f2/oi2ca1yskdtra1m7g.jpg', path: '/play/rio.html' },
    { id: 'game-Angry-Birds-Stella', name: 'Angry Birds Stella', img: 'https://www.mediafire.com/convkey/a0a9/joybetmdtxzk6cm7g.jpg', path: '/play/stella.html' },
    { id: 'game-Basket-Bros', name: 'Basket Bros', img: 'https://www.mediafire.com/convkey/f2cd/5pvv55vzgy80sq97g.jpg', path: '/play/basketbros.html' },
    { id: 'game-Battleship', name: 'Battleship', img: 'https://www.mediafire.com/convkey/b985/jp96yg6v4dr8rzo7g.jpg', path: '/play/battleship.html' },
    { id: 'game-BitLife', name: 'BitLife', img: 'https://www.mediafire.com/convkey/00ec/vcpc59fot723szw7g.jpg', path: '/play/bitlife.html' },
    { id: 'game-Block-Blast', name: 'Block Blast', img: 'https://www.mediafire.com/convkey/acca/4izkblqrulevfn57g.jpg', path: '/play/blockblast.html' },
    { id: 'game-Bad-Piggies', name: 'Bad Piggies', img: 'https://www.mediafire.com/convkey/0866/vsh0682j2w9qxhl7g.jpg', path: '/play/badpiggies.html' },
    { id: 'game-Call-of-Ops-2', name: 'Call of Ops 2', img: 'https://www.mediafire.com/convkey/4a04/gs0b6crk0n5xzhv7g.jpg', path: '/play/callofops2.html' },
    { id: 'game-Call-of-Ops-3', name: 'Call of Ops 3', img: 'https://www.mediafire.com/convkey/3adc/6czeo5tzxhx5hla7g.jpg', path: '/play/callofops3.html' },
    { id: 'game-Call-of-Ops-3-Zombies', name: 'Call of Ops 3 Zombies', img: 'https://www.mediafire.com/convkey/dc19/fyjm4208ciii1d37g.jpg', path: '/play/callofops3zombies.html' },
    { id: 'game-Catac-io', name: 'Catac.io', img: 'https://www.mediafire.com/convkey/835b/2ap4blch50z33p27g.jpg', path: '/play/catacio.html' },
    { id: 'game-Chess', name: 'Chess', img: 'https://www.mediafire.com/convkey/99a3/s5lxuivh0n6jdq47g.jpg', path: '/play/chess.html' },
    { id: 'game-Cookie-Clicker', name: 'Cookie Clicker', img: 'https://www.mediafire.com/convkey/2e18/xf90vbqrawmret77g.jpg', path: '/play/cookieclicker.html' },
    { id: 'game-Cut-the-Rope', name: 'Cut the Rope', img: 'https://www.mediafire.com/convkey/1dc5/ep5lpbtg61zkb2a7g.jpg', path: '/play/cuttherope.html' },
    { id: 'game-Cut-the-Rope-2', name: 'Cut the Rope 2', img: 'https://www.mediafire.com/convkey/9d7e/lcpz8u1t904dgfv7g.jpg', path: '/play/cuttherope2.html' },
    { id: 'game-Dodge-the-Bar', name: 'Dodge the Bar', img: 'https://www.mediafire.com/convkey/c5ac/mr39ydydg5a22oi7g.jpg', path: '/play/dodgethebar.html' },
    { id: 'game-Drift-Boss', name: 'Drift Boss', img: 'https://www.mediafire.com/convkey/e980/c6s9opnclguywbn7g.jpg', path: '/play/driftboss.html' },
    { id: 'game-Fireboy-and-Watergirl', name: 'Fireboy and Watergirl', img: 'https://www.mediafire.com/convkey/c29b/e3n575c8zvwoylj7g.jpg', path: '/play/fireboyandwatergirl.html' },
    { id: 'game-Flappy-Bird', name: 'Flappy Bird', img: 'https://www.mediafire.com/convkey/caa3/ch3tzgf6koc047e7g.jpg', path: '/play/flappybird.html' },
    { id: 'game-FNAF-1', name: 'FNAF 1', img: 'https://www.mediafire.com/convkey/4d91/9bogsg5iuezz0a17g.jpg', path: '/play/fnaf1.html' },
    { id: 'game-FNAF-2', name: 'FNAF 2', img: 'https://www.mediafire.com/convkey/8bc3/5a09bjo1j67b9lt7g.jpg', path: '/play/fnaf2.html' },
    { id: 'game-FNAF-3', name: 'FNAF 3', img: 'https://www.mediafire.com/convkey/c20e/e2plb6ktp5mb8cg7g.jpg', path: '/play/fnaf3.html' },
    { id: 'game-FNAF-4', name: 'FNAF 4', img: 'https://www.mediafire.com/convkey/a18c/wrq22xj6bqzxaky7g.jpg', path: '/play/fnaf4.html' },
    { id: 'game-Friday-Night-Funkin', name: 'Friday Night Funkin', img: 'https://www.mediafire.com/convkey/2692/q47l4ewzosd0ddc7g.jpg', path: '/play/fnf.html' },
    { id: 'game-Fortnite', name: 'Fortnite', img: 'https://www.mediafire.com/convkey/7a48/lk2gegrck5l149r7g.jpg', h2: 'SCRATCH version', path: '/play/fortscratch.html' },
    { id: 'game-Geometry-Dash', name: 'Geometry Dash', img: 'https://www.mediafire.com/convkey/7ae0/3mz9oz0hc63nu4v7g.jpg', path: '/play/geometrydash.html' },
    { id: 'game-Glitch', name: 'Glitch', img: 'https://www.mediafire.com/convkey/dd96/kl9qvz9qxvgf8ri7g.jpg', path: '/play/glitch.html' },
    { id: 'game-Guess-their-Answer', name: 'Guess their Answer', img: 'https://www.mediafire.com/convkey/d3f6/51o2px2f4rauxvb7g.jpg', path: '/play/guesstheiranswer.html' },
    { id: 'game-Subway-Surfers', name: 'Subway Surfers', img: 'https://www.mediafire.com/convkey/d479/f0ijgipurbfrofo7g.jpg', path: '/play/subwaysurfers.html' },
    { id: 'game-Super-Mario-Bros', name: 'Super Mario Bros', img: 'https://www.mediafire.com/convkey/6456/rpuwycg2fp5wr987g.jpg', path: '/play/supermariobros.html' },
    { id: 'game-Tiny-Fishing', name: 'Tiny Fishing', img: 'https://www.mediafire.com/convkey/83b6/vdx1l7p7kbegnnu7g.jpg', path: '/play/tinyfishing.html' },
    { id: 'game-Fantasy-Avengers', name: 'Fantasy Avengers', img: 'https://www.mediafire.com/convkey/20b0/u146qzvpooa02ot7g.jpg', path: '/play/fantasyavengers.html' },
    { id: 'game-Fantasy-Avengers-Stage-2', name: 'Fantasy Avengers Stage 2', img: 'https://www.mediafire.com/convkey/20b0/u146qzvpooa02ot7g.jpg', path: '/play/fantasyavengers2.html' },
    { id: 'game-Fantasy-Avengers-Stage-3', name: 'Fantasy Avengers Stage 3', img: 'https://www.mediafire.com/convkey/20b0/u146qzvpooa02ot7g.jpg', path: '/play/fantasyavengers3.html' },
    { id: 'game-Crazy-Cattle-3D', name: 'Crazy Cattle 3D', img: 'https://crazycattle-3d.com/thumbs/crazy-cattle-3d_1.webp', path: '/play/crazycattle.html' },
    { id: 'game-Super-Mario-64-Web', name: 'Super Mario 64 Web', img: 'https://i.ytimg.com/vi/95EpsdUjTQw/maxresdefault.jpg', path: '/play/64.html' },
    { id: 'game-The-Origin-of-Darwin', name: 'The Origin of Darwin', img: 'https://cn.i.cdn.ti-platform.com/cnemea/content/17043/game/TheOriginOfDarwin-GB-Cover-EN.jpg', path: '/play/darwinorigin.html' }
  ];

  // Store all game data for easy lookup
  window.allGamesData = new Map(); // Map: gameTitle -> { id: 'game-title-id', path: '/play/game.html' }

  // Get elements (these are safe to get globally as they exist from the start)
  // These should be declared with 'let' and assigned inside DOMContentLoaded
  let accentColorPicker;
  let root;
  let searchInput;
  let searchButton;
  let searchResultsDiv;
  let gamePlayerOverlay;
  let gameIframe;
  let reloadGameButton;
  let switchUrlButton;
  let fullScreenButton;
  let exitGameButton;
  let copyLinkButton;
  let tabButtons;
  let tabContents;

  let staticGamesContainer;
  let customGamesContainer;
  let customGamesTitle;

  let storeItemsContainer;
  let languageSelect;
  let resetEverythingButton;
  let resetConfirmationMessage;
  let messageBox;
  let messageBoxText;
  let messageBoxCloseButton;
  let enable3DAnimationCheckbox;
  let background3DCanvas;
  let homeSubtitleTextElement;
  let commandPromptOverlay;
  let consoleOutput;
  let commandInput;
  let fileInput;

  // Declare currentMoneySpan globally, but assign it inside DOMContentLoaded
  let currentMoneySpan;

  // New global variables for hidden/favorite games and context menu
  let hiddenGames = new Set(JSON.parse(localStorage.getItem('epixgamesHiddenGames') || '[]'));
  let favoriteGames = new Set(JSON.parse(localStorage.getItem('epixgamesFavoriteGames') || '[]'));
  let gameContextMenu;
  let contextMenuHideButton;
  let contextMenuToggleFavoriteButton;
  let currentRightClickedGameElement = null; // Store the actual game div element
  let hiddenGamesList;
  let favoriteGamesList;


  // --- Helper Functions ---

  // Custom Message Box
  function showMessageBox(message) {
    messageBoxText.textContent = message;
    messageBox.style.display = 'block';
  }

  // Convert hex to RGB
  const hexToRgb = (hex) => {
    const bigint = parseInt(hex.slice(1), 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return [r, g, b];
  };

  // Convert RGB to hex
  const rgbToHex = (r, g, b) => {
    return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
  };

  // Darken a color by a percentage
  const darkenColor = (hex, percent) => {
    let [r, g, b] = hexToRgb(hex);
    r = Math.max(0, r - Math.floor(r * percent));
    g = Math.max(0, g - Math.floor(g * percent));
    b = Math.max(0, b - Math.floor(b * percent));
    return rgbToHex(r, g, b);
  };

  // HSL to RGB conversion (needed for RGB theme)
  function hslToRgb(h, s, l) {
    s /= 100;
    l /= 100;
    let c = (1 - Math.abs(2 * l - 1)) * s,
        x = c * (1 - Math.abs((h / 60) % 2 - 1)),
        m = l - c / 2,
        r = 0,
        g = 0,
        b = 0;

    if (0 <= h && h < 60) {
      r = c; g = x; b = 0;
    } else if (60 <= h && h < 120) {
      r = x; g = c; b = 0;
    } else if (120 <= h && h < 180) {
      r = 0; g = c; b = x;
    } else if (180 <= h && h < 240) {
      r = 0; g = x; b = c;
    } else if (240 <= h && h < 300) {
      r = x; g = 0; b = c;
    } else if (300 <= h && h < 360) {
      r = c; g = 0; b = x;
    }
    r = Math.round((r + m) * 255);
    g = Math.round((g + m) * 255);
    b = Math.round((b + m) * 255);

    return rgbToHex(r, g, b);
  }

  // Update all accent-related colors
  function updateAccentColors(color) {
    root.style.setProperty('--accent-color', color);
    const hoverColor = darkenColor(color, 0.2);
    root.style.setProperty('--accent-hover-color', hoverColor);
    root.style.setProperty('--primary-color', color);
    root.style.setProperty('--secondary-color', color);
    const darkBgColor = darkenColor(color, 0.5);
    root.style.setProperty('--bg-color', darkBgColor);
    localStorage.setItem('epixgamesAccentColor', color);

    // Update 3D cube colors if animation is active
    if (isAnimationEnabled && animationObjects.length > 0) {
        update3DCubeColors(color);
    }
  }

  // --- RGB Theme Functions ---
  function startRgbEffect() {
    stopRgbEffect(); // Ensure any existing interval is cleared
    currentHue = 0; // Start from red

    rgbIntervalId = setInterval(() => {
      currentHue = (currentHue + 1) % 360; // Cycle hue from 0 to 359
      const newAccentColor = hslToRgb(currentHue, 100, 50); // Full saturation, medium lightness

      // Apply the new accent color
      root.style.setProperty('--accent-color', newAccentColor);
      root.style.setProperty('--accent-hover-color', darkenColor(newAccentColor, 0.2));
      root.style.setProperty('--primary-color', newAccentColor);
      root.style.setProperty('--secondary-color', newAccentColor);

      // Dynamically set the background to a darker version of the current accent color
      const dynamicBgColor = darkenColor(newAccentColor, 0.5);
      root.style.setProperty('--home-background', dynamicBgColor);
      root.style.setProperty('--home-text-color', '#ffffff'); // Force text color to white for RGB theme

      // Update 3D cube colors if animation is active
      if (isAnimationEnabled && animationObjects.length > 0) {
          update3DCubeColors(newAccentColor);
      }
    }, 50); // Update every 50ms for a smooth transition
  }

  function stopRgbEffect() {
    if (rgbIntervalId) {
      clearInterval(rgbIntervalId);
      rgbIntervalId = null;
      // Reset to default theme colors when RGB effect stops
      const defaultTheme = storeItems.find(item => item.id === 'default-theme');
      if (defaultTheme && defaultTheme.type === 'full-theme') {
        for (const prop in defaultTheme.value) {
          root.style.setProperty(prop, defaultTheme.value[prop]);
        }
      }
      // Also reset accent color picker to its last saved value or default
      const savedAccentColor = localStorage.getItem('epixgamesAccentColor');
      updateAccentColors(savedAccentColor || accentColorPicker.value);
    }
  }

  // --- Three.js 3D Animation Functions ---
  function init3DAnimation() {
      if (!background3DCanvas) {
          console.error("3D Canvas element not found!");
          return;
      }
      if (scene && camera && renderer) { // Already initialized
          return;
      }

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ canvas: background3DCanvas, alpha: true, antialias: true }); // alpha: true for transparent background
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio); // Improve quality on high-DPI screens

      // Get the current accent color for initial cube material
      const initialAccentColor = getComputedStyle(root).getPropertyValue('--accent-color').trim();
      const material = new THREE.MeshBasicMaterial({ color: new THREE.Color(initialAccentColor), wireframe: true }); // Green wireframe cubes

      for (let i = 0; i < 50; i++) { // More objects for a cooler effect
          const cube = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), material); // Use the shared material
          cube.position.set(
              (Math.random() - 0.5) * 40, // Wider spread
              (Math.random() - 0.5) * 40,
              (Math.random() - 0.5) * 40
          );
          cube.rotation.set(
              Math.random() * Math.PI,
              Math.random() * Math.PI,
              Math.random() * Math.PI
          );
          scene.add(cube);
          animationObjects.push(cube);
      }

      camera.position.z = 15; // Pull camera back for wider view

      // Handle window resize
      window.addEventListener('resize', onWindowResize3D);
  }

  // New function to update the color of existing 3D cubes
  function update3DCubeColors(color) {
      if (animationObjects.length > 0) {
          const newColor = new THREE.Color(color);
          animationObjects.forEach(obj => {
              if (obj.material) {
                  obj.material.color.set(newColor);
              }
          });
      }
  }

  function onWindowResize3D() {
      if (camera && renderer) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
      }
  }

  function animate3D() {
      if (isAnimationEnabled && renderer) {
          animationFrameId = requestAnimationFrame(animate3D); // Store the ID

          animationObjects.forEach(obj => {
              obj.rotation.x += 0.005;
              obj.rotation.y += 0.005;
          });

          renderer.render(scene, camera);
      }
  }

  function toggle3DAnimation(enable) {
      isAnimationEnabled = enable;
      localStorage.setItem('epixgames3DAnimationEnabled', JSON.stringify(isAnimationEnabled));

      if (isAnimationEnabled) {
          if (!scene) init3DAnimation(); // Initialize if not already
          if (background3DCanvas) background3DCanvas.style.display = 'block';
          // The 3D canvas is z-index: -1, so it will always be behind the body's background.
          animate3D(); // Start the animation loop
          // Ensure cubes match current accent color when animation is enabled
          const currentAccentColor = getComputedStyle(root).getPropertyValue('--accent-color').trim();
          update3DCubeColors(currentAccentColor);
      } else {
          if (background3DCanvas) background3DCanvas.style.display = 'none';
          if (animationFrameId) {
              cancelAnimationFrame(animationFrameId); // Stop the animation loop
              animationFrameId = null;
          }
      }
  }


  // --- Tab Switching Logic ---
  function showTab(tabId) {
    tabContents.forEach(content => {
      content.classList.remove('active');
    });
    tabButtons.forEach(button => {
      button.classList.remove('active');
    });

    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

    // Hide search widget if not on games tab
    const searchWidget = document.querySelector('.search-widget-container');
    if (tabId !== 'games-tab') {
      if (searchWidget) searchWidget.style.display = 'none';
    } else {
      if (searchWidget) searchWidget.style.display = 'flex'; // Or 'block' depending on its flex state
    }

    // Re-render settings tab content when it becomes active
    if (tabId === 'settings-tab') {
        renderHiddenGamesSettings();
        renderFavoriteGamesSettings();
    }
  }

  // --- Game Player Functions ---
  function openGameInIframe(gameRelativePath) {
    currentLoadedGamePath = gameRelativePath;
    gameIframe.src = `${currentBaseUrl}${gameRelativePath}`;
    gamePlayerOverlay.classList.add('active');
    startMoneyGranting(); // Start granting money when game starts
  }

  function reloadIframe() {
    if (currentLoadedGamePath) {
      gameIframe.src = `${currentBaseUrl}${currentLoadedGamePath}`;
    }
  }

  function exitIframe() {
    // Before exiting, update playtime and money
    stopMoneyGranting(); // This will also handle the final money calculation for the session
    gameIframe.src = '';
    gamePlayerOverlay.classList.remove('active');
    currentLoadedGamePath = '';

    const url = new URL(window.location.href);
    if (url.searchParams.has('game')) {
      url.searchParams.delete('game');
      window.history.pushState({}, '', url.toString());
    }
  }

  function copyGameLink() {
    if (currentLoadedGamePath) {
      const shareableUrl = `${window.location.origin}${window.location.pathname}?game=${encodeURIComponent(currentLoadedGamePath)}&base=${encodeURIComponent(currentBaseUrl)}`;
      const tempInput = document.createElement('input');
      tempInput.value = shareableUrl;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      showMessageBox(translations[currentLanguage].linkCopied);
    } else {
      showMessageBox('No game is currently loaded to copy a link for.');
    }
  }

  function switchBaseUrl() {
    let currentIndex = GAME_BASE_URLS.indexOf(currentBaseUrl);
    let nextIndex = (currentIndex + 1) % GAME_BASE_URLS.length;
    currentBaseUrl = GAME_BASE_URLS[nextIndex];
    localStorage.setItem('epixgamesBaseUrl', currentBaseUrl);
    showMessageBox(`Switched game URL to: ${currentBaseUrl}`);
    if (currentLoadedGamePath && gamePlayerOverlay.classList.contains('active')) {
      reloadIframe();
    }
  }

  function toggleFullScreen() {
    if (!document.fullscreenElement) {
      if (gameIframe.requestFullscreen) {
        gameIframe.requestFullscreen();
      } else if (gameIframe.mozRequestFullScreen) {
        gameIframe.mozRequestFullScreen();
      } else if (gameIframe.webkitRequestFullscreen) {
        gameIframe.webkitRequestFullscreen();
      } else if (gameIframe.msRequestFullscreen) {
        gameIframe.msRequestFullscreen();
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  }

  function highlightAndScrollGame(gameTitle) {
    document.querySelectorAll('.highlighted-game').forEach(el => {
      el.classList.remove('highlighted-game');
    });

    const gameData = window.allGamesData.get(gameTitle); // Use window.allGamesData
    if (gameData && gameData.id) {
      const gameElement = document.getElementById(gameData.id);
      if (gameElement) {
        gameElement.classList.add('highlighted-game');
        gameElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Switch to Games tab if not already active
        if (!document.getElementById('games-tab').classList.contains('active')) {
          showTab('games-tab');
        }
        renderAllGames(); // Re-render to ensure visibility if it was hidden
      }
    }
  }

  // --- Search Function ---
  async function performSearch() {
    const query = searchInput.value.trim().toLowerCase();
    searchResultsDiv.innerHTML = ''; // Clear previous results

    if (!query) {
      searchResultsDiv.textContent = "Please enter a search term.";
      return;
    }

    // Check if the query is "cmd" to open the command prompt
    if (query === 'cmd') {
      toggleCommandPrompt();
      searchInput.value = ''; // Clear search input
      searchResultsDiv.innerHTML = ''; // Clear search results
      return; // Exit the function after opening the prompt
    }

    const matchingGames = Array.from(window.allGamesData.keys()).filter(title => // Use window.allGamesData
      title.toLowerCase().includes(query)
    );

    if (matchingGames.length > 0) {
      const resultHeader = document.createElement('p');
      resultHeader.innerHTML = `<strong>Direct Matches:</strong>`;
      searchResultsDiv.appendChild(resultHeader);
      matchingGames.forEach(title => {
        const p = document.createElement('p');
        p.textContent = title;
        p.style.cursor = 'pointer';
        p.onclick = () => highlightAndScrollGame(title);
        searchResultsDiv.appendChild(p);
      });
    } else {
      searchResultsDiv.textContent = "No direct matches found.";
    }
  }

  // --- Money and Store Logic ---
  function updateMoneyDisplay() {
    // Use the globally declared currentMoneySpan which is assigned in DOMContentLoaded
    if (currentMoneySpan) {
      console.log("Attempting to update money display. Money value:", money);
      currentMoneySpan.textContent = money;
      console.log("Money display updated to:", money);
    } else {
      console.error("Error: currentMoneySpan element not found during updateMoneyDisplay!");
    }
  }

  function updatePlaytimeAndMoney() {
    console.log("updatePlaytimeAndMoney called.");
    if (!gamePlayerOverlay.classList.contains('active')) {
      console.log("Game not active, stopping money granting.");
      stopMoneyGranting();
      return;
    }

    const now = Date.now();
    // Calculate elapsed seconds since the last update or session start
    const elapsedSecondsInInterval = Math.floor((now - sessionStartTime) / 1000);

    // Only proceed if at least one second has truly passed
    if (elapsedSecondsInInterval < 1) {
        console.log("Less than one second elapsed, skipping update.");
        return;
    }

    const oldTotalPlaytimeSeconds = totalPlaytimeSeconds; // Store for comparison
    totalPlaytimeSeconds += elapsedSecondsInInterval; // Accumulate playtime
    localStorage.setItem('epixgamesTotalPlaytimeSeconds', totalPlaytimeSeconds);
    console.log(`Accumulated playtime: ${totalPlaytimeSeconds} seconds.`);

    const oldMinutesEarned = Math.floor(oldTotalPlaytimeSeconds / 60);
    const newMinutesEarned = Math.floor(totalPlaytimeSeconds / 60);

    if (newMinutesEarned > oldMinutesEarned) {
      const minutesToAward = newMinutesEarned - oldMinutesEarned;
      money += (minutesToAward * 5);
      localStorage.setItem('epixgamesMoney', money);
      updateMoneyDisplay(); // Call updateMoneyDisplay here to refresh the UI
      console.log(`Earned ${minutesToAward * 5} money! Total: ${money}`);
    }

    // Reset sessionStartTime for the next interval calculation
    sessionStartTime = now;
  }

  function startMoneyGranting() {
    if (moneyInterval) clearInterval(moneyInterval); // Clear any existing interval

    sessionStartTime = Date.now(); // Mark the beginning of this earning period
    console.log("startMoneyGranting called. Session start time set to:", sessionStartTime);

    // Start the interval to update playtime and potentially grant money every second
    moneyInterval = setInterval(updatePlaytimeAndMoney, 1000); // Check every second
    console.log("Money granting interval started (checking every second).");
  }

  function stopMoneyGranting() {
    if (moneyInterval) {
      clearInterval(moneyInterval);
      moneyInterval = null;
      console.log("Money granting interval stopped.");

      // Ensure any remaining partial seconds in the current session are accounted for
      if (sessionStartTime > 0) {
        const remainingSessionDurationSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
        if (remainingSessionDurationSeconds > 0) {
            const oldTotalPlaytimeSecondsBeforeExit = totalPlaytimeSeconds;
            totalPlaytimeSeconds += remainingSessionDurationSeconds;
            localStorage.setItem('epixgamesTotalPlaytimeSeconds', totalPlaytimeSeconds);
            console.log(`(On exit) Added remaining ${remainingSessionDurationSeconds} seconds. New total playtime: ${totalPlaytimeSeconds}`);

            const oldMinutesEarned = Math.floor(oldTotalPlaytimeSecondsBeforeExit / 60);
            const newMinutesEarned = Math.floor(totalPlaytimeSeconds / 60);

            if (newMinutesEarned > oldMinutesEarned) {
                const minutesToAward = newMinutesEarned - oldMinutesEarned;
                money += (minutesToAward * 5);
                localStorage.setItem('epixgamesMoney', money);
                updateMoneyDisplay(); // Call updateMoneyDisplay here to refresh the UI
                console.log(`(On exit) Earned ${minutesToAward * 5} money! Total: ${money}`);
            }
        }
        sessionStartTime = 0; // Reset session start
      }
    }
  }

  function renderStore() {
    storeItemsContainer.innerHTML = ''; // Clear previous items

    // Combine default and custom themes
    const allStoreItems = [...storeItems, ...window.customThemes]; // Use window.customThemes

    allStoreItems.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'store-item';

      const img = document.createElement('img');
      img.src = item.img || 'https://placehold.co/100x100/3c4048/FFFFFF?text=Item'; // Placeholder if no img
      img.alt = item.name;
      itemDiv.appendChild(img);

      const name = document.createElement('h4');
      name.textContent = item.name;
      itemDiv.appendChild(name);

      const statusText = document.createElement('p');
      const buyApplyButton = document.createElement('button');

      if (ownedAccessories[item.id] || item.default) {
        // Item is owned or is a default item
        statusText.textContent = translations[currentLanguage].ownedText;
        buyApplyButton.textContent = translations[currentLanguage].applyButton;
        buyApplyButton.disabled = (appliedAccessory === item.id); // Disable if already applied
        if (appliedAccessory === item.id) {
          buyApplyButton.textContent = translations[currentLanguage].appliedText;
        }
        buyApplyButton.onclick = () => applyAccessory(item.id);
      } else {
        // Item is not owned
        statusText.textContent = `${item.cost} 💰`;
        buyApplyButton.textContent = translations[currentLanguage].buyButton.replace('{cost}', item.cost);
        buyApplyButton.disabled = (money < item.cost); // Disable if not enough money
        buyApplyButton.onclick = () => buyAccessory(item.id, item.cost);
      }

      itemDiv.appendChild(statusText);
      itemDiv.appendChild(buyApplyButton);
      storeItemsContainer.appendChild(itemDiv);
    });
  }

  function buyAccessory(itemId, cost) {
    if (money >= cost) {
      money -= cost;
      ownedAccessories[itemId] = true;
      localStorage.setItem('epixgamesMoney', money);
      localStorage.setItem('epixgamesOwnedAccessories', JSON.stringify(ownedAccessories));
      updateMoneyDisplay();
      renderStore(); // Re-render store to update button states
      applyAccessory(itemId); // Automatically apply after buying
    } else {
      showMessageBox(translations[currentLanguage].insufficientFunds);
    }
  }

  function applyAccessory(itemId) {
    const allStoreItems = [...storeItems, ...window.customThemes]; // Use window.customThemes
    const item = allStoreItems.find(i => i.id === itemId);
    if (!item) return;

    // Always stop RGB effect before applying any theme
    stopRgbEffect();

    // Determine if 3D animation should be enabled based on user setting and theme compatibility
    // RGB theme is now compatible with 3D animation
    const userPrefers3D = JSON.parse(localStorage.getItem('epixgames3DAnimationEnabled') || 'false');
    const isThemeCompatibleWith3D = (itemId !== 'classic-theme'); // Only classic-theme disables 3D
    isAnimationEnabled = userPrefers3D && isThemeCompatibleWith3D;
    toggle3DAnimation(isAnimationEnabled);
    if (enable3DAnimationCheckbox) enable3DAnimationCheckbox.checked = userPrefers3D;


    // Remove theme classes from body
    document.body.classList.remove('classic-theme', 'rgb-theme');

    // Reset all relevant CSS variables to their default values
    root.style.setProperty('--home-background', '#282c34'); // Default background
    root.style.setProperty('--home-text-color', '#ffffff'); // Default text color for body
    root.style.setProperty('--text-color', '#ffffff'); // Default general text color
    root.style.setProperty('--bg-color', '#282c34'); // Default base background for cards etc.
    root.style.setProperty('--primary-color', '#4287f5'); // Default primary accent
    root.style.setProperty('--secondary-color', '#61dafb'); // Default secondary accent
    root.style.setProperty('--card-bg', '#3c4048'); // Default card background
    root.style.setProperty('--button-bg', 'var(--accent-color, #61dafb)'); // Default button background
    root.style.setProperty('--button-hover-bg', 'var(--accent-hover-color, #21a1f1)'); // Default button hover

    // Re-apply accent color as it's independent of full themes
    const savedAccentColor = localStorage.getItem('epixgamesAccentColor');
    updateAccentColors(savedAccentColor || '#61dafb'); // Re-apply default or saved accent color

    if (item.type === 'background') {
      root.style.setProperty('--home-background', item.value);
      // Text color remains default white set above, unless explicitly changed by another item.
    } else if (item.type === 'text-color') {
      root.style.setProperty('--home-text-color', item.value);
      root.style.setProperty('--primary-color', item.value); // Apply to primary
      root.style.setProperty('--secondary-color', item.value); // Apply to secondary
      root.style.setProperty('--text-color', item.value); // Apply to general text
    } else if (item.type === 'full-theme') {
      if (itemId === 'classic-theme') {
        document.body.classList.add('classic-theme');
        // Classic theme uses !important in CSS, so direct variable setting here is less critical,
        // but setting them for consistency doesn't hurt.
        root.style.setProperty('--home-background', '#4287f5');
        root.style.setProperty('--home-text-color', '#ffffff');
        root.style.setProperty('--bg-color', '#4287f5');
        root.style.setProperty('--primary-color', '#007bff');
        root.style.setProperty('--secondary-color', '#007bff');
        root.style.setProperty('--card-bg', 'transparent');
        root.style.setProperty('--button-bg', '#007bff');
        root.style.setProperty('--button-hover-bg', '#0056b3');
      } else {
        // For default-theme (and future full themes), apply its specific values
        for (const prop in item.value) {
          root.style.setProperty(prop, item.value[prop]);
        }
      }
    } else if (item.type === 'dynamic-theme' && item.id === 'rgb-theme') {
      document.body.classList.add('rgb-theme');
      startRgbEffect();
    }

    appliedAccessory = itemId;
    localStorage.setItem('epixgamesAppliedAccessory', itemId);
    renderStore();
    toggleAccentColorPickerState();
  }

  // --- Settings Logic ---
  function applyLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('epixgamesLanguage', lang);
    languageSelect.value = lang; // Set dropdown value

    // Update all elements with data-i18n-key
    document.querySelectorAll('[data-i18n-key]').forEach(element => {
      const key = element.dataset.i18nKey;
      if (translations[lang] && translations[lang][key]) {
        element.textContent = translations[lang][key];
      }
    });

    // Special handling for placeholder
    if (searchInput) {
      searchInput.placeholder = translations[currentLanguage].searchPlaceholder || "Search games...";
    }

    // Update banner text immediately on language change
    cycleBannerText(0); // Reset to first text

    // Re-render store to update button texts
    renderStore();
    // Update custom games title translation
    if (customGamesTitle) {
        customGamesTitle.textContent = translations[currentLanguage].customGamesSectionTitle;
    }
    // Update hidden/favorite games settings lists
    renderHiddenGamesSettings();
    renderFavoriteGamesSettings();
  }

  function resetAllData() {
    resetConfirmCount++;
    clearTimeout(resetConfirmTimeout); // Clear previous timeout

    if (resetConfirmCount >= 5) {
      showMessageBox(translations[currentLanguage].resetFinalConfirm);
      localStorage.clear(); // Clear all local storage data
      // Also clear in-memory sets
      hiddenGames.clear();
      favoriteGames.clear();
      sequences = {};
      window.customGames = [];
      window.customThemes = [];
      htmlModifications = [];

      setTimeout(() => {
        window.location.reload(); // Reload the page to apply reset
      }, 1000);
    } else {
      resetConfirmationMessage.textContent = translations[currentLanguage].resetConfirm.replace('{count}', (5 - resetConfirmCount));
      resetConfirmTimeout = setTimeout(() => {
        resetConfirmCount = 0; // Reset count if no further clicks within 3 seconds
        resetConfirmationMessage.textContent = '';
      }, 3000);
    }
  }

  function toggleAccentColorPickerState() {
      if (appliedAccessory === 'classic-theme') { // Only classic-theme disables the picker now
          accentColorPicker.disabled = true;
          accentColorPicker.style.opacity = 0.5;
          accentColorPicker.style.cursor = 'not-allowed';
      } else {
          accentColorPicker.disabled = false;
          accentColorPicker.style.opacity = 1;
          accentColorPicker.style.cursor = 'pointer';
      }
  }

  // --- Banner Cycling Logic ---
  function cycleBannerText(startIndex = -1) {
    if (!homeSubtitleTextElement) return; // Use the new subtitle element

    const texts = translations[currentLanguage].bannerTexts;
    if (!texts || texts.length === 0) {
      homeSubtitleTextElement.textContent = "";
      return;
    }

    if (startIndex !== -1) {
      bannerTextIndex = startIndex;
    } else {
      bannerTextIndex = (bannerTextIndex + 1) % texts.length;
    }

    homeSubtitleTextElement.style.opacity = 0; // Start fade out
    setTimeout(() => {
      homeSubtitleTextElement.textContent = texts[bannerTextIndex];
      homeSubtitleTextElement.style.opacity = 1; // Fade in
    }, 500); // Half a second for fade out, then change text and fade in
  }

  // --- Command Prompt Functions ---
  function toggleCommandPrompt() {
    isCommandPromptOpen = !isCommandPromptOpen;
    if (isCommandPromptOpen) {
      commandPromptOverlay.style.display = 'flex';
      commandInput.focus();
      appendToConsoleOutput("EPIXGAMES Command Prompt v1.0");
      appendToConsoleOutput("Type 'HELP' for commands.");
    } else {
      commandPromptOverlay.style.display = 'none';
      commandInput.value = '';
      consoleOutput.innerHTML = ''; // Clear console output on close
      document.activeElement.blur(); // Remove focus from input
      commandPromptState = { mode: 'normal', subMode: '', data: {} }; // Reset state
    }
  }

  function appendToConsoleOutput(text) {
    const p = document.createElement('p');
    p.textContent = text;
    consoleOutput.appendChild(p);
    consoleOutput.scrollTop = consoleOutput.scrollHeight; // Auto-scroll to bottom
  }

  // Helper to validate hex color
  function isValidHexColor(color) {
      return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
  }

  async function handleCommand(commandLine) {
    const originalCommandLine = commandLine; // Store original for sequence recording
    appendToConsoleOutput(`> ${commandLine}`);

    const parts = commandLine.trim().toUpperCase().split(/\s+/);
    const command = parts[0];
    const args = parts.slice(1);

    // --- DEBUGGING LOGS ---
    console.log("DEBUG: commandPromptState.mode before switch:", commandPromptState.mode);
    console.log("DEBUG: command received:", command);
    console.log("DEBUG: args received:", args);
    // --- END DEBUGGING LOGS ---

    // --- Multi-step command handling ---
    if (commandPromptState.mode === 'recording_commands') {
      if (command === 'END_SEQUENCE') {
        sequences[commandPromptState.data.name] = commandPromptState.data.commands;
        localStorage.setItem('epixgamesCommandSequences', JSON.stringify(sequences));
        appendToConsoleOutput(translations[currentLanguage].cmdSequenceAddEnd.replace('{name}', commandPromptState.data.name).replace('{count}', commandPromptState.data.commands.length));
        commandPromptState = { mode: 'normal', subMode: '', data: {} };
      } else {
        commandPromptState.data.commands.push(originalCommandLine); // Save original case for sequence
        appendToConsoleOutput(`  Added: ${originalCommandLine}`);
      }
      return;
    }

    if (commandPromptState.mode === 'awaiting_sequence_name') {
      if (commandLine.trim() === '') {
        appendToConsoleOutput(translations[currentLanguage].cmdNoSequenceToRecord);
        commandPromptState = { mode: 'normal', subMode: '', data: {} };
        return;
      }
      const seqName = commandLine.trim();
      if (sequences[seqName]) {
        appendToConsoleOutput(translations[currentLanguage].cmdSequenceNameExists.replace('{name}', seqName));
        commandPromptState = { mode: 'normal', subMode: '', data: {} };
        return;
      }
      commandPromptState = { mode: 'recording_commands', data: { name: seqName, commands: [] } };
      appendToConsoleOutput(translations[currentLanguage].cmdSequenceAddRecording.replace('{name}', seqName));
      return;
    }

    if (commandPromptState.mode === 'awaiting_game_input') {
        switch (commandPromptState.subMode) {
            case 'title':
                commandPromptState.data.title = originalCommandLine;
                commandPromptState.subMode = 'image';
                appendToConsoleOutput(translations[currentLanguage].cmdGameAddImage);
                break;
            case 'image':
                commandPromptState.data.img = originalCommandLine;
                commandPromptState.subMode = 'path';
                appendToConsoleOutput(translations[currentLanguage].cmdGameAddPath);
                break;
            case 'path':
                commandPromptState.data.path = originalCommandLine;
                const newGame = {
                    id: `game-${commandPromptState.data.title.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}`, // Unique ID
                    name: commandPromptState.data.title,
                    img: commandPromptState.data.img,
                    path: commandPromptState.data.path
                };
                window.customGames.push(newGame); // Use window.customGames
                localStorage.setItem('epixgamesCustomGames', JSON.stringify(window.customGames)); // Use window.customGames
                appendToConsoleOutput(translations[currentLanguage].cmdGameAdded.replace('{title}', newGame.name));
                renderAllGames(); // Re-render all games to show new one
                commandPromptState = { mode: 'normal', subMode: '', data: {} };
                break;
        }
        return;
    }

    if (commandPromptState.mode === 'awaiting_theme_input') {
        switch (commandPromptState.subMode) {
            case 'name':
                commandPromptState.data.name = originalCommandLine;
                commandPromptState.subMode = 'primary';
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreatePrimary);
                break;
            case 'primary':
                if (!isValidHexColor(originalCommandLine)) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidColor);
                    return;
                }
                commandPromptState.data.primary = originalCommandLine;
                commandPromptState.subMode = 'secondary';
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreateSecondary);
                break;
            case 'secondary':
                if (!isValidHexColor(originalCommandLine)) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidColor);
                    return;
                }
                commandPromptState.data.secondary = originalCommandLine;
                commandPromptState.subMode = 'bg';
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreateBg);
                break;
            case 'bg':
                if (!isValidHexColor(originalCommandLine)) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidColor);
                    return;
                }
                commandPromptState.data.bg = originalCommandLine;
                commandPromptState.subMode = 'text';
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreateText);
                break;
            case 'text':
                if (!isValidHexColor(originalCommandLine)) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidColor);
                    return;
                }
                commandPromptState.data.text = originalCommandLine;
                commandPromptState.subMode = 'cardBg';
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreateCardBg);
                break;
            case 'cardBg':
                if (!isValidHexColor(originalCommandLine)) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidColor);
                    return;
                }
                commandPromptState.data.cardBg = originalCommandLine;
                commandPromptState.subMode = 'buttonBg';
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreateButtonBg);
                break;
            case 'buttonBg':
                if (!isValidHexColor(originalCommandLine)) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidColor);
                    return;
                }
                commandPromptState.data.buttonBg = originalCommandLine;

                const newTheme = {
                    id: `custom-theme-${commandPromptState.data.name.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}`, // Unique ID
                    name: commandPromptState.data.name,
                    type: 'full-theme',
                    value: {
                        '--home-background': commandPromptState.data.bg,
                        '--home-text-color': commandPromptState.data.text,
                        '--bg-color': commandPromptState.data.bg,
                        '--primary-color': commandPromptState.data.primary,
                        '--secondary-color': commandPromptState.data.secondary,
                        '--card-bg': commandPromptState.data.cardBg,
                        '--button-bg': commandPromptState.data.buttonBg,
                        '--button-hover-bg': darkenColor(commandPromptState.data.buttonBg, 0.2)
                    },
                    cost: 0, // Custom themes are free once created
                    default: false,
                    img: 'https://placehold.co/100x100/3c4048/FFFFFF?text=Custom' // Generic image for custom themes
                };
                window.customThemes.push(newTheme); // Use window.customThemes
                localStorage.setItem('epixgamesCustomThemes', JSON.stringify(window.customThemes)); // Use window.customThemes
                appendToConsoleOutput(translations[currentLanguage].cmdThemeCreated.replace('{name}', newTheme.name));
                renderStore(); // Re-render store to show new custom theme
                commandPromptState = { mode: 'normal', subMode: '', data: {} };
                break;
        }
        return;
    }

    if (commandPromptState.mode === 'awaiting_html_modify_input') {
        switch (commandPromptState.subMode) {
            case 'selector':
                commandPromptState.data.selector = originalCommandLine;
                commandPromptState.subMode = 'property';
                appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyProperty);
                break;
            case 'property':
                commandPromptState.data.property = originalCommandLine;
                commandPromptState.subMode = 'value';
                appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyValue);
                break;
            case 'value':
                commandPromptState.data.value = originalCommandLine;
                const newMod = {
                    selector: commandPromptState.data.selector,
                    property: commandPromptState.data.property,
                    value: commandPromptState.data.value
                };
                htmlModifications.push(newMod);
                localStorage.setItem('epixgamesHtmlModifications', JSON.stringify(htmlModifications));
                applyHtmlModifications(); // Apply immediately
                appendToConsoleOutput(translations[currentLanguage].cmdHtmlModified);
                commandPromptState = { mode: 'normal', subMode: '', data: {} };
                break;
        }
        return;
    }

    if (commandPromptState.mode === 'awaiting_custom_settings_input') {
        switch (commandPromptState.subMode) {
            case 'money':
                const moneyInput = parseInt(originalCommandLine);
                if (isNaN(moneyInput) || moneyInput < 0) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidAmount);
                    return; // Stay in this subMode until valid input
                }
                commandPromptState.data.money = moneyInput;
                commandPromptState.subMode = 'language';
                appendToConsoleOutput(translations[currentLanguage].cmdCustomSettingsLanguagePrompt);
                break;
            case 'language':
                const langInput = originalCommandLine.toLowerCase();
                if (!translations[langInput]) {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidLanguage);
                    return; // Stay in this subMode
                }
                commandPromptState.data.language = langInput;
                commandPromptState.subMode = 'animation3D';
                appendToConsoleOutput(translations[currentLanguage].cmdCustomSettings3DAnimationPrompt);
                break;
            case 'animation3D':
                const animationInput = originalCommandLine.toLowerCase();
                if (animationInput !== 'true' && animationInput !== 'false') {
                    appendToConsoleOutput(translations[currentLanguage].cmdInvalidBoolean);
                    return; // Stay in this subMode
                }
                commandPromptState.data.animation3D = (animationInput === 'true');

                const customSettings = {
                    epixgamesMoney: commandPromptState.data.money,
                    epixgamesLanguage: commandPromptState.data.language,
                    epixgames3DAnimationEnabled: commandPromptState.data.animation3D
                    // Other settings like owned accessories, custom games, themes, html mods
                    // are complex and will not be part of this simplified custom settings creation.
                    // They can still be imported/exported via SETTINGS_IMPORT/EXPORT.
                };

                const customSettingsBlob = new Blob([JSON.stringify(customSettings, null, 2)], { type: 'application/json' });
                const customSettingsA = document.createElement('a');
                customSettingsA.href = URL.createObjectURL(customSettingsBlob);
                customSettingsA.download = 'epixgames_custom_user_settings.json'; // New filename
                document.body.appendChild(customSettingsA);
                customSettingsA.click();
                document.body.removeChild(customSettingsA);
                appendToConsoleOutput(translations[currentLanguage].cmdCustomSettingsFileCreated);
                commandPromptState = { mode: 'normal', subMode: '', data: {} }; // Reset state
                break;
        }
        return; // Important to return here
    }


    // --- Normal command handling ---
    switch (command) {
      case 'CUSTOM_SETTINGS': // Moved to top for debugging
          commandPromptState = { mode: 'awaiting_custom_settings_input', subMode: 'money', data: {} };
          appendToConsoleOutput(translations[currentLanguage].cmdCustomSettingsMoneyPrompt);
          break;
      case 'EXIT':
        appendToConsoleOutput(translations[currentLanguage].cmdExit);
        setTimeout(toggleCommandPrompt, 300); // Close after a short delay
        break;
      case 'HELP':
        appendToConsoleOutput(translations[currentLanguage].cmdHelp);
        break;
      case 'MONEY_ADD':
        const addAmount = parseInt(args[0]);
        if (!isNaN(addAmount)) {
          money += addAmount;
          localStorage.setItem('epixgamesMoney', money);
          updateMoneyDisplay();
          appendToConsoleOutput(translations[currentLanguage].cmdMoneyAdded.replace('{amount}', addAmount).replace('{balance}', money));
        } else {
          appendToConsoleOutput(translations[currentLanguage].cmdInvalidAmount);
        }
        break;
      case 'MONEY_REMOVE':
        const removeAmount = parseInt(args[0]);
        if (!isNaN(removeAmount)) {
          money = Math.max(0, money - removeAmount); // Don't go below 0
          localStorage.setItem('epixgamesMoney', money);
          updateMoneyDisplay();
          appendToConsoleOutput(translations[currentLanguage].cmdMoneyRemoved.replace('{amount}', removeAmount).replace('{balance}', money));
        } else {
          appendToConsoleOutput(translations[currentLanguage].cmdInvalidAmount);
        }
        break;
      case 'MONEY_SET':
        const setAmount = parseInt(args[0]);
        if (!isNaN(setAmount)) {
          money = Math.max(0, setAmount); // Don't allow negative money
          localStorage.setItem('epixgamesMoney', money);
          updateMoneyDisplay();
          appendToConsoleOutput(translations[currentLanguage].cmdMoneySet.replace('{balance}', money));
        } else {
          appendToConsoleOutput(translations[currentLanguage].cmdInvalidAmount);
        }
        break;
      case 'IFRAME_OPEN':
        const url = args.join(' ');
        try {
          new URL(url); // Validate URL format
          openGameInIframe(url);
          appendToConsoleOutput(translations[currentLanguage].cmdIframeOpened.replace('{url}', url));
          toggleCommandPrompt(); // Close prompt after opening iframe
        } catch (e) {
          appendToConsoleOutput(translations[currentLanguage].cmdInvalidUrl);
        }
        break;
      case 'SEQUENCE_ADD':
        if (args.length > 0) {
          const seqName = args[0];
          if (sequences[seqName]) {
            appendToConsoleOutput(translations[currentLanguage].cmdSequenceNameExists.replace('{name}', seqName));
            return;
          }
          commandPromptState = { mode: 'recording_commands', data: { name: seqName, commands: [] } };
          appendToConsoleOutput(translations[currentLanguage].cmdSequenceAddRecording.replace('{name}', seqName));
        } else {
          commandPromptState = { mode: 'awaiting_sequence_name', subMode: '', data: {} };
          appendToConsoleOutput(translations[currentLanguage].cmdSequenceAddStart);
        }
        break;
      case 'SEQUENCE_DO':
        const sequenceName = args[0];
        if (sequenceName && sequences[sequenceName]) {
          appendToConsoleOutput(translations[currentLanguage].cmdSequenceExecuting.replace('{name}', sequenceName));
          sequences[sequenceName].forEach(cmd => {
            handleCommand(cmd); // Recursively execute commands in sequence
          });
        } else {
          appendToConsoleOutput(translations[currentLanguage].cmdSequenceNotFound.replace('{name}', sequenceName || ''));
        }
        break;
      case 'GAME_ADD':
          commandPromptState = { mode: 'awaiting_game_input', subMode: 'title', data: {} };
          appendToConsoleOutput(translations[currentLanguage].cmdGameAddTitle);
          break;
      case 'GAME_SHOW_CUSTOM': // New command implementation
          const isCustomVisible = customGamesContainer.style.display !== 'none';
          customGamesContainer.style.display = isCustomVisible ? 'none' : 'flex';
          customGamesTitle.style.display = isCustomVisible ? 'none' : 'block';
          if (!isCustomVisible) {
              renderAllGames(); // Ensure custom games are rendered when shown
          }
          appendToConsoleOutput(translations[currentLanguage].cmdGameShowCustomToggled);
          break;
      case 'THEME_CREATE':
          commandPromptState = { mode: 'awaiting_theme_input', subMode: 'name', data: {} };
          appendToConsoleOutput(translations[currentLanguage].cmdThemeCreateName);
          break;
      case 'THEME_ADD':
          appendToConsoleOutput(translations[currentLanguage].cmdThemeAddPrompt);
          fileInput.onchange = (e) => {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      try {
                          const importedTheme = JSON.parse(event.target.result);
                          if (importedTheme.id && importedTheme.name && importedTheme.type && importedTheme.value) {
                              window.customThemes.push(importedTheme); // Use window.customThemes
                              localStorage.setItem('epixgamesCustomThemes', JSON.stringify(window.customThemes)); // Use window.customThemes
                              renderStore();
                              appendToConsoleOutput(translations[currentLanguage].cmdThemeAdded.replace('{name}', importedTheme.name));
                          } else {
                              appendToConsoleOutput(translations[currentLanguage].cmdThemeAddError.replace('{error}', 'Invalid theme file structure.'));
                          }
                      } catch (error) {
                          appendToConsoleOutput(translations[currentLanguage].cmdThemeAddError.replace('{error}', error.message));
                      } finally {
                          fileInput.value = ''; // Clear the file input
                          fileInput.onchange = null; // Remove event listener
                      }
                  };
                  reader.onerror = (error) => {
                      appendToConsoleOutput(translations[currentLanguage].cmdFileReadError.replace('{error}', error.message));
                      fileInput.value = ''; // Clear the file input
                      fileInput.onchange = null; // Remove event listener
                  };
                  reader.readAsText(file);
              } else {
                  fileInput.value = ''; // Clear the file input
                  fileInput.onchange = null; // Remove event listener
              }
          };
          fileInput.click(); // Trigger file input click
          break;
      case 'THEME_EXPORT': // New command implementation
          if (window.customThemes.length === 0) {
              appendToConsoleOutput("No custom themes to export.");
              return;
          }
          const customThemesData = JSON.stringify(window.customThemes, null, 2);
          const themeBlob = new Blob([customThemesData], { type: 'application/json' });
          const themeA = document.createElement('a');
          themeA.href = URL.createObjectURL(themeBlob);
          themeA.download = 'epixgames_custom_themes.json';
          document.body.appendChild(themeA);
          themeA.click();
          document.body.removeChild(themeA);
          appendToConsoleOutput(translations[currentLanguage].cmdThemeExported);
          break;
      case 'HTML_MODIFY':
          commandPromptState = { mode: 'awaiting_html_modify_input', subMode: 'selector', data: {} };
          appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifySelector);
          break;
      case 'HTML_MODIFY_OPEN':
          if (htmlModifications.length === 0) {
              appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyNone);
              return;
          }
          appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyList);
          htmlModifications.forEach((mod, index) => {
              appendToConsoleOutput(`${index + 1}. Selector: "${mod.selector}", Property: "${mod.property}", Value: "${mod.value}"`);
          });
          appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyOpenSelect);
          commandPromptState = { mode: 'normal', subMode: 'awaiting_html_modify_index', data: {} }; // New sub-mode to handle index input
          break;
      case 'HTML_MODIFY_EXPORT':
          const currentHtml = document.documentElement.outerHTML;
          const blob = new Blob([currentHtml], { type: 'text/html' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'epixgames_site.html';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyExported);
          break;
      case 'SETTINGS_EXPORT':
          const settingsToExport = {
              epixgamesMoney: money,
              epixgamesOwnedAccessories: ownedAccessories,
              epixgamesAppliedAccessory: appliedAccessory,
              epixgamesLanguage: currentLanguage,
              epixgamesTotalPlaytimeSeconds: totalPlaytimeSeconds,
              epixgames3DAnimationEnabled: isAnimationEnabled,
              epixgamesCommandSequences: sequences,
              epixgamesCustomGames: window.customGames, // Use window.customGames
              epixgamesCustomThemes: window.customThemes, // Use window.customThemes
              epixgamesHtmlModifications: htmlModifications,
              epixgamesAccentColor: localStorage.getItem('epixgamesAccentColor'),
              epixgamesHiddenGames: Array.from(hiddenGames), // Export hidden games
              epixgamesFavoriteGames: Array.from(favoriteGames) // Export favorite games
          };
          const settingsBlob = new Blob([JSON.stringify(settingsToExport, null, 2)], { type: 'application/json' });
          const settingsA = document.createElement('a');
          settingsA.href = URL.createObjectURL(settingsBlob);
          settingsA.download = 'epixgames_settings.json';
          document.body.appendChild(settingsA);
          settingsA.click();
          document.body.removeChild(settingsA);
          appendToConsoleOutput(translations[currentLanguage].cmdSettingsExported);
          break;
      case 'SETTINGS_IMPORT':
          appendToConsoleOutput(translations[currentLanguage].cmdSettingsImportPrompt);
          fileInput.onchange = (e) => {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      try {
                          const importedSettings = JSON.parse(event.target.result);
                          for (const key in importedSettings) {
                              // Special handling for objects that need to be parsed from string
                              if (['epixgamesOwnedAccessories', 'epixgamesCommandSequences', 'epixgamesCustomGames', 'epixgamesCustomThemes', 'epixgamesHtmlModifications'].includes(key)) {
                                  localStorage.setItem(key, JSON.stringify(importedSettings[key]));
                              } else if (key === 'epixgamesHiddenGames') { // Handle Set for hidden games
                                  localStorage.setItem(key, JSON.stringify(importedSettings[key]));
                                  hiddenGames = new Set(importedSettings[key]);
                              } else if (key === 'epixgamesFavoriteGames') { // Handle Set for favorite games
                                  localStorage.setItem(key, JSON.stringify(importedSettings[key]));
                                  favoriteGames = new Set(importedSettings[key]);
                              }
                              else {
                                  localStorage.setItem(key, importedSettings[key]);
                              }
                          }
                          appendToConsoleOutput(translations[currentLanguage].cmdSettingsImported);
                          setTimeout(() => window.location.reload(), 1000); // Reload to apply all settings
                      } catch (error) {
                          appendToConsoleOutput(translations[currentLanguag].cmdSettingsImportError.replace('{error}', error.message));
                      } finally {
                          fileInput.value = ''; // Clear the file input
                          fileInput.onchange = null; // Remove event listener
                      }
                  };
                  reader.onerror = (error) => {
                      appendToConsoleOutput(translations[currentLanguage].cmdFileReadError.replace('{error}', error.message));
                      fileInput.value = ''; // Clear the file input
                      fileInput.onchange = null; // Remove event listener
                  };
                  reader.readAsText(file);
              } else {
                  fileInput.value = ''; // Clear the file input
                  fileInput.onchange = null; // Remove event listener
              }
          };
          fileInput.click(); // Trigger file input click
          break;
      default:
        // Handle sub-mode for HTML_MODIFY_OPEN index input
        if (commandPromptState.subMode === 'awaiting_html_modify_index') {
            const index = parseInt(commandLine) - 1; // Adjust for 0-based index
            if (!isNaN(index) && index >= 0 && index < htmlModifications.length) {
                const mod = htmlModifications[index];
                appendToConsoleOutput(`Details for modification ${index + 1}:`);
                appendToConsoleOutput(`  Selector: "${mod.selector}"`);
                appendToConsoleOutput(`  Property: "${mod.property}"`);
                appendToConsoleOutput(`  Value: "${mod.value}"`);
            } else {
                appendToConsoleOutput(translations[currentLanguage].cmdHtmlModifyOpenInvalid);
            }
            commandPromptState = { mode: 'normal', subMode: '', data: {} }; // Reset state
            break;
        }
        appendToConsoleOutput(translations[currentLanguage].cmdUnknownCommand.replace('{command}', command));
        break;
    }
  }

  // New function to render a list of games into a container
  function renderGames(gamesArray, containerElement) {
      containerElement.innerHTML = ''; // Clear the container

      gamesArray.forEach(game => {
          const gameDiv = document.createElement('div');
          gameDiv.className = 'game';
          gameDiv.id = game.id; // Ensure game has a unique ID

          // Check if game is hidden (this class is now applied by renderAllGames for filtering)
          // if (hiddenGames.has(game.id)) {
          //     gameDiv.classList.add('hidden');
          // }

          // Check if game is favorited
          if (favoriteGames.has(game.id)) {
              gameDiv.classList.add('favorited');
              const favoriteIcon = document.createElement('span');
              favoriteIcon.className = 'favorite-icon';
              favoriteIcon.textContent = '⭐'; // Star emoji
              gameDiv.appendChild(favoriteIcon);
          }

          const img = document.createElement('img');
          img.src = game.img;
          img.alt = game.name;
          gameDiv.appendChild(img);

          const dl = document.createElement('dl');
          const dt = document.createElement('dt');
          dt.textContent = game.name;
          dl.appendChild(dt);

          if (game.h2) {
            const h2 = document.createElement('h2');
            h2.textContent = game.h2;
            dl.appendChild(h2);
          }

          const button = document.createElement('button');
          button.className = 'play-now-button';
          button.textContent = translations[currentLanguage].playNowButton || 'Play Now'; // Ensure this translation key exists
          button.dataset.gamePath = game.path;
          button.onclick = () => openGameInIframe(game.path);
          dl.appendChild(button);

          gameDiv.appendChild(dl);
          containerElement.appendChild(gameDiv);

          // Add to allGamesData map for search functionality (if not already there)
          if (!window.allGamesData.has(game.name)) {
              window.allGamesData.set(game.name, { id: game.id, path: game.path });
          }

          // Attach right-click listener to each game card
          gameDiv.addEventListener('contextmenu', (event) => showContextMenu(event, gameDiv));
      });
  }

  // New function to sort and render all games
  function renderAllGames() {
      // Combine static and custom games
      let allDisplayableGames = [...window.staticGameDefinitions, ...window.customGames];

      // Filter out hidden games
      allDisplayableGames = allDisplayableGames.filter(game => !hiddenGames.has(game.id));

      // Sort: favorited games first, then by name
      allDisplayableGames.sort((a, b) => {
          const aFav = favoriteGames.has(a.id);
          const bFav = favoriteGames.has(b.id);

          if (aFav && !bFav) return -1; // a is favorited, b is not - a comes first
          if (!aFav && bFav) return 1;  // b is favorited, a is not - b comes first
          return a.name.localeCompare(b.name); // Then sort alphabetically
      });

      // Clear existing containers before rendering
      if (staticGamesContainer) staticGamesContainer.innerHTML = '';
      if (customGamesContainer) customGamesContainer.innerHTML = '';

      // Separate games into static and custom for rendering into their respective containers
      const staticGamesToRender = allDisplayableGames.filter(game => window.staticGameDefinitions.some(staticGame => staticGame.id === game.id));
      const customGamesToRender = allDisplayableGames.filter(game => window.customGames.some(customGame => customGame.id === game.id));

      renderGames(staticGamesToRender, staticGamesContainer);

      // Only show custom games title and container if there are custom games AND they are not hidden
      if (customGamesToRender.length > 0) {
          customGamesTitle.style.display = 'block';
          customGamesContainer.style.display = 'flex'; // Use flex for the container
          renderGames(customGamesToRender, customGamesContainer);
      } else {
          customGamesTitle.style.display = 'none';
          customGamesContainer.style.display = 'none';
      }
  }

  // Context Menu Functions
  function showContextMenu(event, gameElement) {
      event.preventDefault(); // Prevent default browser context menu
      currentRightClickedGameElement = gameElement; // Store the element

      // Update menu item text based on current state
      if (hiddenGames.has(gameElement.id)) {
          contextMenuHideButton.textContent = translations[currentLanguage].unhideGameText;
      } else {
          contextMenuHideButton.textContent = translations[currentLanguage].hideGameText;
      }

      if (favoriteGames.has(gameElement.id)) {
          contextMenuToggleFavoriteButton.textContent = translations[currentLanguage].unfavoriteGameText;
      } else {
          contextMenuToggleFavoriteButton.textContent = translations[currentLanguage].favoriteGameText;
      }

      // Display the menu first to get its dimensions
      gameContextMenu.style.display = 'block';

      // Calculate position to keep it within viewport
      let x = event.clientX;
      let y = event.clientY;
      const menuWidth = gameContextMenu.offsetWidth;
      const menuHeight = gameContextMenu.offsetHeight;
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      // Add a small offset so the menu doesn't appear directly under the cursor
      const offset = 10;

      if (x + menuWidth + offset > viewportWidth) {
          x = viewportWidth - menuWidth - offset;
      } else {
          x += offset;
      }

      if (y + menuHeight + offset > viewportHeight) {
          y = viewportHeight - menuHeight - offset;
      } else {
          y += offset;
      }

      gameContextMenu.style.left = `${x}px`;
      gameContextMenu.style.top = `${y}px`;
  }

  function hideContextMenu() {
      if (gameContextMenu) {
          gameContextMenu.style.display = 'none';
      }
      currentRightClickedGameElement = null;
  }

  // Hide/Unhide Game Logic
  function hideGame(gameId) {
      // Remove from favorites if it was favorited
      if (favoriteGames.has(gameId)) {
          favoriteGames.delete(gameId);
          localStorage.setItem('epixgamesFavoriteGames', JSON.stringify(Array.from(favoriteGames)));
      }

      hiddenGames.add(gameId);
      localStorage.setItem('epixgamesHiddenGames', JSON.stringify(Array.from(hiddenGames)));
      showMessageBox(translations[currentLanguage].gameHidden);
      renderAllGames(); // Re-render all games to hide it
      renderHiddenGamesSettings(); // Update settings list
      renderFavoriteGamesSettings(); // Update favorite list (if it was removed)
  }

  function unhideGame(gameId) {
      hiddenGames.delete(gameId);
      localStorage.setItem('epixgamesHiddenGames', JSON.stringify(Array.from(hiddenGames)));
      showMessageBox(translations[currentLanguage].gameUnhidden);
      renderAllGames(); // Re-render all games to show it
      renderHiddenGamesSettings(); // Update settings list
  }

  // Favorite/Unfavorite Game Logic
  function toggleFavorite(gameId) {
      if (favoriteGames.has(gameId)) {
          favoriteGames.delete(gameId);
          showMessageBox(translations[currentLanguage].gameUnfavorited);
      } else {
          // If a game is hidden, unhide it when favorited
          if (hiddenGames.has(gameId)) {
              hiddenGames.delete(gameId);
              showMessageBox(translations[currentLanguage].gameUnhidden); // Inform user it's unhidden
          }
          favoriteGames.add(gameId);
          showMessageBox(translations[currentLanguage].gameFavorited);
      }
      localStorage.setItem('epixgamesFavoriteGames', JSON.stringify(Array.from(favoriteGames)));
      localStorage.setItem('epixgamesHiddenGames', JSON.stringify(Array.from(hiddenGames))); // Update hidden status if changed
      renderAllGames(); // Re-render all games to apply sorting and visual indicator
      renderFavoriteGamesSettings(); // Update settings list
      renderHiddenGamesSettings(); // Update hidden list (if it was unhidden)
  }

  // Settings Render Functions
  function renderHiddenGamesSettings() {
      hiddenGamesList.innerHTML = '';
      if (hiddenGames.size === 0) {
          hiddenGamesList.textContent = "No hidden games."; // Add a message for empty list
          return;
      }
      hiddenGames.forEach(gameId => {
          // Find game data from either static or custom definitions
          const gameData = [...window.staticGameDefinitions, ...window.customGames].find(g => g.id === gameId);
          if (gameData) {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'management-item';
              itemDiv.textContent = gameData.name;
              const unhideButton = document.createElement('button');
              unhideButton.className = 'play-now-button unhide-button'; // Reusing play-now-button for styling
              unhideButton.textContent = translations[currentLanguage].unhideGameText;
              unhideButton.onclick = () => unhideGame(gameId);
              itemDiv.appendChild(unhideButton);
              hiddenGamesList.appendChild(itemDiv);
          }
      });
  }

  function renderFavoriteGamesSettings() {
      favoriteGamesList.innerHTML = '';
      if (favoriteGames.size === 0) {
          favoriteGamesList.textContent = "No favorite games."; // Add a message for empty list
          return;
      }
      favoriteGames.forEach(gameId => {
          // Find game data from either static or custom definitions
          const gameData = [...window.staticGameDefinitions, ...window.customGames].find(g => g.id === gameId);
          if (gameData) {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'management-item';
              itemDiv.textContent = gameData.name;
              const unfavoriteButton = document.createElement('button');
              unfavoriteButton.className = 'play-now-button unfavorite-button'; // Reusing play-now-button for styling
              unfavoriteButton.textContent = translations[currentLanguage].unfavoriteGameText;
              unfavoriteButton.onclick = () => toggleFavorite(gameId); // Use toggleFavorite to unfavorite
              itemDiv.appendChild(unfavoriteButton);
              favoriteGamesList.appendChild(itemDiv);
          }
      });
  }


  // Function to apply saved HTML modifications
  function applyHtmlModifications() {
      htmlModifications.forEach(mod => {
          try {
              const elements = document.querySelectorAll(mod.selector);
              elements.forEach(el => {
                  el.style.setProperty(mod.property, mod.value);
              });
          } catch (e) {
              console.error(`Error applying HTML modification for selector "${mod.selector}":`, e);
          }
      });
  }


  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', () => {
    // Assign all DOM elements here, at the very beginning of DOMContentLoaded
    accentColorPicker = document.getElementById('accentColorPicker');
    root = document.documentElement;
    searchInput = document.getElementById('searchInput');
    searchButton = document.getElementById('searchButton');
    searchResultsDiv = document.getElementById('searchResults');
    gamePlayerOverlay = document.getElementById('gamePlayerOverlay');
    gameIframe = document.getElementById('gameIframe');
    reloadGameButton = document.getElementById('reloadGameButton');
    switchUrlButton = document.getElementById('switchUrlButton');
    fullScreenButton = document.getElementById('fullScreenButton');
    exitGameButton = document.getElementById('exitGameButton');
    copyLinkButton = document.getElementById('copyLinkButton');
    tabButtons = document.querySelectorAll('.tab-button');
    tabContents = document.querySelectorAll('.tab-content');

    staticGamesContainer = document.getElementById('staticGamesContainer');
    customGamesContainer = document.getElementById('customGamesContainer');
    customGamesTitle = document.getElementById('customGamesTitle');

    storeItemsContainer = document.getElementById('storeItemsContainer');
    languageSelect = document.getElementById('languageSelect');
    resetEverythingButton = document.getElementById('resetEverythingButton');
    resetConfirmationMessage = document.getElementById('resetConfirmationMessage');
    messageBox = document.getElementById('messageBox');
    messageBoxText = document.getElementById('messageBoxText');
    messageBoxCloseButton = document.getElementById('messageBoxCloseButton');
    enable3DAnimationCheckbox = document.getElementById('enable3DAnimation');
    background3DCanvas = document.getElementById('background3DCanvas');
    homeSubtitleTextElement = document.getElementById('homeSubtitleText');
    commandPromptOverlay = document.getElementById('commandPromptOverlay');
    consoleOutput = document.getElementById('consoleOutput');
    commandInput = document.getElementById('commandInput');
    fileInput = document.getElementById('fileInput');
    currentMoneySpan = document.getElementById('currentMoney'); // Assign currentMoneySpan here

    // New element assignments for context menu and settings lists
    gameContextMenu = document.getElementById('gameContextMenu');
    contextMenuHideButton = document.getElementById('contextMenuHide');
    contextMenuToggleFavoriteButton = document.getElementById('contextMenuToggleFavorite');
    hiddenGamesList = document.getElementById('hiddenGamesList');
    favoriteGamesList = document.getElementById('favoriteGamesList');


    console.log("currentMoneySpan element found (inside DOMContentLoaded):", currentMoneySpan);

    // --- URL Parameter Processing ---
    const urlParams = new URLSearchParams(window.location.search);
    let paramsProcessed = false;

    // ?add_money=###
    const addMoneyValue = urlParams.get('add_money');
    if (addMoneyValue) {
      const amount = parseInt(addMoneyValue);
      if (!isNaN(amount) && amount > 0) {
        money += amount;
        localStorage.setItem('epixgamesMoney', money);
        showMessageBox(`Added ${amount} money!`);
        paramsProcessed = true;
      }
    }

    // ?add_infinitemoney
    if (urlParams.has('add_infinitemoney')) {
      money = 999999999999; // A very large number
      localStorage.setItem('epixgamesMoney', money);
      showMessageBox('Infinite money unlocked! 🤑');
      paramsProcessed = true;
    }

    // ?add_allitems
    if (urlParams.has('add_allitems')) {
      storeItems.forEach(item => {
        ownedAccessories[item.id] = true;
      });
      window.customThemes.forEach(item => { // Also add custom themes (use window.customThemes)
        ownedAccessories[item.id] = true;
      });
      localStorage.setItem('epixgamesOwnedAccessories', JSON.stringify(ownedAccessories));
      showMessageBox('All store items unlocked! ✨');
      paramsProcessed = true;
    }

    // Clean up URL parameters after processing
    if (paramsProcessed) {
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.delete('add_money');
      newUrl.searchParams.delete('add_infinitemoney');
      newUrl.searchParams.delete('add_allitems');
      window.history.replaceState({}, document.title, newUrl.toString());
    }
    // --- End URL Parameter Processing ---

    // NOW, render the games based on these definitions
    renderAllGames(); // This will clear and re-add based on staticGameDefinitions and custom games

    // Load saved accent color
    const savedAccentColor = localStorage.getItem('epixgamesAccentColor');
    if (savedAccentColor) {
      accentColorPicker.value = savedAccentColor;
      updateAccentColors(savedAccentColor);
    } else {
      updateAccentColors(accentColorPicker.value);
    }

    // Load saved base URL
    const savedBaseUrl = localStorage.getItem('epixgamesBaseUrl');
    if (savedBaseUrl && GAME_BASE_URLS.includes(savedBaseUrl)) {
      currentBaseUrl = savedBaseUrl;
    }

    // Initialize money display
    updateMoneyDisplay();

    // Initialize owned accessories (ensure default theme is always owned)
    if (!ownedAccessories['default-theme']) {
      ownedAccessories['default-theme'] = true;
      localStorage.setItem('epixgamesOwnedAccessories', JSON.stringify(ownedAccessories));
    }

    // Apply saved accessory
    // This will also handle the initial state of 3D animation and RGB theme
    applyAccessory(appliedAccessory);

    // Set initial state of 3D animation checkbox
    if (enable3DAnimationCheckbox) {
        // The applyAccessory function now correctly sets isAnimationEnabled based on userPrefers3D and theme compatibility.
        // So, just set the checkbox state to match the user's saved preference.
        enable3DAnimationCheckbox.checked = JSON.parse(localStorage.getItem('epixgames3DAnimationEnabled') || 'false');
        enable3DAnimationCheckbox.addEventListener('change', (event) => {
            // When the checkbox is toggled, update the user's preference in localStorage
            localStorage.setItem('epixgames3DAnimationEnabled', JSON.stringify(event.target.checked));
            // Then re-apply the current accessory to ensure the 3D animation state is correctly updated
            applyAccessory(appliedAccessory);
        });
    }


    // Initialize language
    applyLanguage(currentLanguage);

    // --- Event Listeners ---
    accentColorPicker.addEventListener('input', (event) => {
      // If RGB or Classic theme is active, changing accent color should stop it
      if (appliedAccessory === 'rgb-theme' || appliedAccessory === 'classic-theme') {
        stopRgbEffect(); // This will also remove rgb-theme class and reset colors
        // For classic theme, we need to explicitly remove the class and re-apply default
        if (appliedAccessory === 'classic-theme') {
          document.body.classList.remove('classic-theme');
          applyAccessory('default-theme'); // Revert to default theme
        }
        // Set appliedAccessory back to default or a static theme
        appliedAccessory = 'default-theme';
        localStorage.setItem('epixgamesAppliedAccessory', appliedAccessory);
      }
      updateAccentColors(event.target.value);
    });

    tabButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        showTab(event.target.dataset.tab);
      });
    });

    // Play button listeners are now attached within renderGames()

    reloadGameButton.addEventListener('click', reloadIframe);
    switchUrlButton.addEventListener('click', switchBaseUrl);
    fullScreenButton.addEventListener('click', toggleFullScreen);
    exitGameButton.addEventListener('click', exitIframe);
    copyLinkButton.addEventListener('click', copyGameLink);

    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        performSearch();
      }
    });

    languageSelect.addEventListener('change', (event) => {
      applyLanguage(event.target.value);
    });

    resetEverythingButton.addEventListener('click', resetAllData);

    // Message box close button listener
    messageBoxCloseButton.addEventListener('click', () => {
      messageBox.style.display = 'none';
    });

    // Event listener for context menu items
    contextMenuHideButton.addEventListener('click', () => {
        if (currentRightClickedGameElement) {
            hideGame(currentRightClickedGameElement.id);
            hideContextMenu();
        }
    });

    contextMenuToggleFavoriteButton.addEventListener('click', () => {
        if (currentRightClickedGameElement) {
            toggleFavorite(currentRightClickedGameElement.id);
            hideContextMenu();
        }
    });

    // Hide context menu when clicking anywhere else
    document.addEventListener('click', (event) => {
        if (gameContextMenu && !gameContextMenu.contains(event.target)) {
            hideContextMenu();
        }
    });


    // Check for game parameter in URL on page load
    const gameToLoad = urlParams.get('game');
    const baseToLoad = urlParams.get('base');

    if (gameToLoad) {
      openGameInIframe(decodeURIComponent(gameToLoad));
      showTab('games-tab'); // Ensure games tab is active if a game is loaded via URL
    } else {
      showTab('games-tab'); // Default to Games tab on initial load
    }

    // Render store items initially
    renderStore();
    toggleAccentColorPickerState(); // Initial state for picker

    // Start banner text cycling
    cycleBannerText(0); // Display first text immediately
    bannerIntervalId = setInterval(cycleBannerText, 5000); // Change text every 5 seconds

    // Command Prompt Key Listeners
    document.addEventListener('keydown', (e) => {
      keyState[e.code] = true;

      // Check for Left CTRL + Right CTRL
      if (keyState['ControlLeft'] && keyState['ControlRight'] && !isCommandPromptOpen) {
        toggleCommandPrompt();
        e.preventDefault(); // Prevent default browser behavior (e.g., zoom)
      }
      // Fallback: Check for CTRL + ALT
      else if (keyState['ControlLeft'] && keyState['AltLeft'] && !isCommandPromptOpen) {
        toggleCommandPrompt();
        e.preventDefault();
      }
      else if (e.key === 'Escape' && isCommandPromptOpen) {
        // Allow Escape to close the prompt
        toggleCommandPrompt();
        e.preventDefault();
      }
    });

    document.addEventListener('keyup', (e) => {
      keyState[e.code] = false;
    });

    commandInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const commandLine = commandInput.value.trim();
        commandInput.value = ''; // Clear input immediately
        if (commandLine) {
          handleCommand(commandLine);
        }
      }
    });

    // Apply any saved HTML modifications on load
    applyHtmlModifications();
  });
</script>

</body>
</html>
�